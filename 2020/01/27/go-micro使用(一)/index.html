<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>微服务：(八)go-micro使用(一) | 星脉</title><meta name="description" content="微服务：(八)go-micro使用(一)"><meta name="keywords" content="Golang,微服务"><meta name="author" content="wangguangatap"><meta name="copyright" content="wangguangatap"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="微服务：(八)go-micro使用(一)"><meta name="twitter:description" content="微服务：(八)go-micro使用(一)"><meta name="twitter:image" content="https://wangguangatap.github.io/img/weifuwu/weifuwu.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="微服务：(八)go-micro使用(一)"><meta property="og:url" content="https://wangguangatap.github.io/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%B8%80)/"><meta property="og:site_name" content="星脉"><meta property="og:description" content="微服务：(八)go-micro使用(一)"><meta property="og:image" content="https://wangguangatap.github.io/img/weifuwu/weifuwu.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wangguangatap.github.io/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%B8%80)/"><link rel="prev" title="微服务：(七)go-micro框架介绍" href="https://wangguangatap.github.io/2020/01/27/go-micro%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/"><link rel="next" title="微服务：(八)go-micro使用(二)" href="https://wangguangatap.github.io/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%BA%8C)/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">星脉</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">66</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#go-micro-使用-一"><span class="toc_mobile_items-text">go-micro 使用(一)</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一、心跳机制与可选项配置"><span class="toc_mobile_items-text">一、心跳机制与可选项配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1、背景"><span class="toc_mobile_items-text">1.1、背景</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-2、代码实现-consul-配置"><span class="toc_mobile_items-text">1.2、代码实现 consul 配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-3、插件化"><span class="toc_mobile_items-text">1.3、插件化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-4、服务注册发现的原理"><span class="toc_mobile_items-text">1.4、服务注册发现的原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-5、未发现服务错误"><span class="toc_mobile_items-text">1.5、未发现服务错误</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-5-1、指定服务程序注册到-consul"><span class="toc_mobile_items-text">1.5.1、指定服务程序注册到 consul</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-5-2、运行客户端服务"><span class="toc_mobile_items-text">1.5.2、运行客户端服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-5-3、未发现服务错误"><span class="toc_mobile_items-text">1.5.3、未发现服务错误</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-6、弊端与解决方法"><span class="toc_mobile_items-text">1.6、弊端与解决方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-6-1、TTL-和间隔时间"><span class="toc_mobile_items-text">1.6.1、TTL 和间隔时间</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二、解耦利器–事件驱动机制"><span class="toc_mobile_items-text">二、解耦利器–事件驱动机制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-1、背景"><span class="toc_mobile_items-text">2.1、背景</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-1、缺点"><span class="toc_mobile_items-text">2.1.1、缺点</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-2、发布-订阅机制"><span class="toc_mobile_items-text">2.2、发布&#x2F;订阅机制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-2-1、事件驱动"><span class="toc_mobile_items-text">2.2.1、事件驱动</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-2-2、事件发布"><span class="toc_mobile_items-text">2.2.2、事件发布</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-2-3、事件订阅"><span class="toc_mobile_items-text">2.2.3、事件订阅</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-3、Broker"><span class="toc_mobile_items-text">2.3、Broker</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-3-1、定义"><span class="toc_mobile_items-text">2.3.1、定义</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-4、安装-go-plugins"><span class="toc_mobile_items-text">2.4、安装 go-plugins</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-4-1、源码库"><span class="toc_mobile_items-text">2.4.1、源码库</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-4-2、安装"><span class="toc_mobile_items-text">2.4.2、安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-4-3、Broker-实现"><span class="toc_mobile_items-text">2.4.3、Broker 实现</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-5、MQTT-介绍及环境搭建"><span class="toc_mobile_items-text">2.5、MQTT 介绍及环境搭建</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-5-1、MQTT-简介"><span class="toc_mobile_items-text">2.5.1、MQTT 简介</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-5-2、MQTT-安装"><span class="toc_mobile_items-text">2.5.2、MQTT 安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-5-3、运行-mosquitto"><span class="toc_mobile_items-text">2.5.3、运行 mosquitto</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-6、编程实现"><span class="toc_mobile_items-text">2.6、编程实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-6-1、消息组件初始化"><span class="toc_mobile_items-text">2.6.1、消息组件初始化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-6-2、消息订阅"><span class="toc_mobile_items-text">2.6.2、消息订阅</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-6-3、消息发布"><span class="toc_mobile_items-text">2.6.3、消息发布</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-7、运行程序"><span class="toc_mobile_items-text">2.7、运行程序</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-7-1、启动-mqtt-服务器"><span class="toc_mobile_items-text">2.7.1、启动 mqtt 服务器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-7-2、启动-server-程序"><span class="toc_mobile_items-text">2.7.2、启动 server 程序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-7-3、错误"><span class="toc_mobile_items-text">2.7.3、错误</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-7-4、启动-client-程序"><span class="toc_mobile_items-text">2.7.4、启动 client 程序</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-8、弊端"><span class="toc_mobile_items-text">2.8、弊端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9、googlepubsub"><span class="toc_mobile_items-text">2.9、googlepubsub</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#go-micro-使用-一"><span class="toc-text">go-micro 使用(一)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、心跳机制与可选项配置"><span class="toc-text">一、心跳机制与可选项配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、背景"><span class="toc-text">1.1、背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、代码实现-consul-配置"><span class="toc-text">1.2、代码实现 consul 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3、插件化"><span class="toc-text">1.3、插件化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4、服务注册发现的原理"><span class="toc-text">1.4、服务注册发现的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5、未发现服务错误"><span class="toc-text">1.5、未发现服务错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1、指定服务程序注册到-consul"><span class="toc-text">1.5.1、指定服务程序注册到 consul</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2、运行客户端服务"><span class="toc-text">1.5.2、运行客户端服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3、未发现服务错误"><span class="toc-text">1.5.3、未发现服务错误</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6、弊端与解决方法"><span class="toc-text">1.6、弊端与解决方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1、TTL-和间隔时间"><span class="toc-text">1.6.1、TTL 和间隔时间</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、解耦利器–事件驱动机制"><span class="toc-text">二、解耦利器–事件驱动机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、背景"><span class="toc-text">2.1、背景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1、缺点"><span class="toc-text">2.1.1、缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2、发布-订阅机制"><span class="toc-text">2.2、发布&#x2F;订阅机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1、事件驱动"><span class="toc-text">2.2.1、事件驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2、事件发布"><span class="toc-text">2.2.2、事件发布</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3、事件订阅"><span class="toc-text">2.2.3、事件订阅</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3、Broker"><span class="toc-text">2.3、Broker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1、定义"><span class="toc-text">2.3.1、定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4、安装-go-plugins"><span class="toc-text">2.4、安装 go-plugins</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1、源码库"><span class="toc-text">2.4.1、源码库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2、安装"><span class="toc-text">2.4.2、安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3、Broker-实现"><span class="toc-text">2.4.3、Broker 实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5、MQTT-介绍及环境搭建"><span class="toc-text">2.5、MQTT 介绍及环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1、MQTT-简介"><span class="toc-text">2.5.1、MQTT 简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2、MQTT-安装"><span class="toc-text">2.5.2、MQTT 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3、运行-mosquitto"><span class="toc-text">2.5.3、运行 mosquitto</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6、编程实现"><span class="toc-text">2.6、编程实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1、消息组件初始化"><span class="toc-text">2.6.1、消息组件初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2、消息订阅"><span class="toc-text">2.6.2、消息订阅</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-3、消息发布"><span class="toc-text">2.6.3、消息发布</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7、运行程序"><span class="toc-text">2.7、运行程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1、启动-mqtt-服务器"><span class="toc-text">2.7.1、启动 mqtt 服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-2、启动-server-程序"><span class="toc-text">2.7.2、启动 server 程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-3、错误"><span class="toc-text">2.7.3、错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-4、启动-client-程序"><span class="toc-text">2.7.4、启动 client 程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8、弊端"><span class="toc-text">2.8、弊端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9、googlepubsub"><span class="toc-text">2.9、googlepubsub</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/weifuwu/weifuwu.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">微服务：(八)go-micro使用(一)</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-01-27<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-06-01</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="go-micro-使用-一"><a href="#go-micro-使用-一" class="headerlink" title="go-micro 使用(一)"></a>go-micro 使用(一)</h1><h2 id="一、心跳机制与可选项配置"><a href="#一、心跳机制与可选项配置" class="headerlink" title="一、心跳机制与可选项配置"></a>一、心跳机制与可选项配置</h2><h3 id="1-1、背景"><a href="#1-1、背景" class="headerlink" title="1.1、背景"></a>1.1、背景</h3><p>在前面一节课中,我们指定了 consul 作为微服务的注册组件，并在 consul 中看到了注册的新服务。这其中还包含其他内容，本节课我们继续来看。</p>
<h3 id="1-2、代码实现-consul-配置"><a href="#1-2、代码实现-consul-配置" class="headerlink" title="1.2、代码实现 consul 配置"></a>1.2、代码实现 consul 配置</h3><p>上节课中，我们使用的–registry 选项配置的形式来指定注册到 consul 组件中，其实这一配置也可以在代码中进行实现。上节课说了 go-micro 在创建服务时提供了很多可选项配置，其中就包含服务组件的指定。指定注册到 consul 的编程代码实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">   <span class="comment">//创建一个新的服务对象实例</span></span><br><span class="line">	service := micro.NewService(</span><br><span class="line">		micro.Name(<span class="string">"student_service"</span>),</span><br><span class="line">		micro.Version(<span class="string">"v1.0.0"</span>),</span><br><span class="line">		micro.Registry(consul.NewRegistry()),</span><br><span class="line">	)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>通过 micro.Registry 可以指定要注册的发现组件，这里我们注册到 consul，因此调用 consul.NewRegistry。</p>
<h3 id="1-3、插件化"><a href="#1-3、插件化" class="headerlink" title="1.3、插件化"></a>1.3、插件化</h3><p>在前面的 go-micro 介绍课中，我们提到过 go-micro 是支持插件化的基础的微服务框架，不仅仅是 go-micro，整个的 micro 都被设计成为“可插拔”的机制。</p>
<p>在上一节课的案例中，我们使用–registry 选项指定将服务注册到对应的服务发现组件，我们选择的是注册到 consul 中。这里的–registry 就是是“可插拔”的插件化机制的体现。因为在 2019 年最新的代码中，go-micro 中默认将服务注册到 mdns 中，同时支持开发者手动指定特定的服务发现组件。</p>
<p>我们可以看到在这个过程中，我们的服务的程序没有发生任何变化，但是却轻松的实现了服务注册发现组件的更换，这就是插件化的优势，利用插件化能最大限度的解耦。</p>
<p>在 go-micro 框架中，支持 consul，etcd，zookeeper，dns 等组件实现服务注册和发现的功能。如果有需要，开发者可以根据自己的需要进行服务发现组件的替换。</p>
<h3 id="1-4、服务注册发现的原理"><a href="#1-4、服务注册发现的原理" class="headerlink" title="1.4、服务注册发现的原理"></a>1.4、服务注册发现的原理</h3><p>让我们再回顾一下服务注册与发现的原理：服务注册发现是将所有的服务注册到注册组件中心，各服务在进行互相调用功能时，先通过查询方法获取到要调用的服务的状态信息和地址，然后向对应的微服务模块发起调用。我们学习过 consul 的工作原理和环境搭建，congsul 的工作原理图如下所示：<br><a href="/img/weifuwu/WX20190828-152536@2x.png" data-fancybox="group" data-caption="consul注册与发现" class="fancybox"><img alt="consul注册与发现" title="consul注册与发现" data-src="/img/weifuwu/WX20190828-152536@2x.png" class="lazyload"></a></p>
<h3 id="1-5、未发现服务错误"><a href="#1-5、未发现服务错误" class="headerlink" title="1.5、未发现服务错误"></a>1.5、未发现服务错误</h3><p>回顾完了服务注册发现的原理，我们就可以知道，如果请求发起端程序不能在服务组件中发现对应的服务，则会产生错误。接下来我们利用程序演示错误。</p>
<p>首先，通过终端命令启动 consul 节点服务，以方便服务注册：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure></div>

<h4 id="1-5-1、指定服务程序注册到-consul"><a href="#1-5-1、指定服务程序注册到-consul" class="headerlink" title="1.5.1、指定服务程序注册到 consul"></a>1.5.1、指定服务程序注册到 consul</h4><p>我们利用已经学习过的服务注册可选项指定注册到 consul 组件，详细命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run main.<span class="keyword">go</span> --registry=consul</span><br></pre></td></tr></table></figure></div>

<p>通过该命令，可以成功将服务注册到 consul 组件，并启动服务开始运行。</p>
<h4 id="1-5-2、运行客户端服务"><a href="#1-5-2、运行客户端服务" class="headerlink" title="1.5.2、运行客户端服务"></a>1.5.2、运行客户端服务</h4><p>由于服务端程序已经注册到 consul,因此客户端程序在执行时也需要到 consul 中查询才能正确执行。运行客户端并注册到 consul 组件的命令是：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run client.<span class="keyword">go</span> --registry=consul</span><br></pre></td></tr></table></figure></div>

<p>通过以上命令，程序可以正确得到执行，并输出正确结果。</p>
<h4 id="1-5-3、未发现服务错误"><a href="#1-5-3、未发现服务错误" class="headerlink" title="1.5.3、未发现服务错误"></a>1.5.3、未发现服务错误</h4><p>我们可以主动让程序发生错误，来验证未发现的错误，以此来验证我们所学习的服务注册与发现的原理。在执行客户端程序时，我们不指定–registry 选项，默认使用 mdns，则命令为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run client.<span class="keyword">go</span></span><br></pre></td></tr></table></figure></div>

<p>我们执行上述命令，运行客户端程序。由于我们的客户端程序会连接对应的服务的方法，但是对应的服务并没有注册到 mdns 中，因此，程序会发生错误。本案例中，客户端程序执行错误如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;id&quot;:&quot;go.micro.client&quot;,&quot;code&quot;:500,&quot;detail&quot;:&quot;error selecting student_service node: not found&quot;,&quot;status&quot;:&quot;Internal Server Error&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到，程序返回了错误信息，提示我们服务未找到。</p>
<p>通过这个主动错误的示范，我们能更加深刻的理解 go-micro 与 consul 的插件式协同工作和微服务内部的原理。</p>
<h3 id="1-6、弊端与解决方法"><a href="#1-6、弊端与解决方法" class="headerlink" title="1.6、弊端与解决方法"></a>1.6、弊端与解决方法</h3><p>服务实例与发现组件的工作机制是：当服务开启时，将自己的相关信息注册到发现组件中，当服务关闭时，发送卸载或者移除请求。在实际生产环境中，服务可能会出现很多异常情况，发生宕机或者其他等情况，往往服务进程会被销毁，或者网络出现故障也会导致通信链路发生问题，在这些情况下，服务实例会在服务发现组件中被移除。</p>
<h4 id="1-6-1、TTL-和间隔时间"><a href="#1-6-1、TTL-和间隔时间" class="headerlink" title="1.6.1、TTL 和间隔时间"></a>1.6.1、TTL 和间隔时间</h4><p>为了解决这个问题，go-micro 框架提供了 TTL 机制和间隔时间注册机制。TTL 是 Time-To-Live 的缩写，指定一次注册在注册组件中的有效期，过期后便会删除。而间隔时间注册则表示定时向注册组件中重新注册以确保服务在线。</p>
<ul>
<li><p>指令方式<br>这两种注册方式都可以通过可选项指令来实现配置，具体的命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run main.<span class="keyword">go</span> --registry=consul --register_ttl=<span class="number">10</span> --register_interval=<span class="number">5</span></span><br></pre></td></tr></table></figure></div>

<p>该命令表示我们每间隔 5 秒钟向服务注册组件注册一次，每次有效期限是 10 秒。</p>
</li>
<li><p>编码方式<br>除了使用指令的方式以外，还可以在代码中实现这两种参数的设定，在微服务创建时通过配置来完成。具体代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">service := micro.NewService(</span><br><span class="line">,</span><br><span class="line">,</span><br><span class="line">,</span><br><span class="line">,</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>分别通过 micro.RegisterTTL 和 micro.RegisterInterval 来实现两个选项的设置。</p>
</li>
</ul>
<h2 id="二、解耦利器–事件驱动机制"><a href="#二、解耦利器–事件驱动机制" class="headerlink" title="二、解耦利器–事件驱动机制"></a>二、解耦利器–事件驱动机制</h2><p>前面我们已经学习了创建微服务和启动微服务的可选项配置，今天我们来学习事件驱动机制</p>
<h3 id="2-1、背景"><a href="#2-1、背景" class="headerlink" title="2.1、背景"></a>2.1、背景</h3><p>之前的课程中我们已经学习了使用 go-micro 创建微服务，并实现了服务的调用。我们具体的实现是实例化了 client 对象，并调用了对应服务的相关方法。这种方式可以实现系统功能，但有比较大的缺点。</p>
<p>我们通过举例来说明：在某个系统中存在用户服务（user service)、产品服务（product service)和消息服务（message service）。如果用户服务中要调用消息服务中的功能方法，则具体的实现方式可用下图所示方法表示：</p>
<p><a href="/img/weifuwu/WX20190831-163801@2x.png" data-fancybox="group" data-caption="高耦合调用方式" class="fancybox"><img alt="高耦合调用方式" title="高耦合调用方式" data-src="/img/weifuwu/WX20190831-163801@2x.png" class="lazyload"></a></p>
<p>按照正常的实现是在 user service 模块的程序中实例化 message service 的一个 client，然后进行 RPC 调用，调用 sendMessage 来实现发送消息。</p>
<h4 id="2-1-1、缺点"><a href="#2-1-1、缺点" class="headerlink" title="2.1.1、缺点"></a>2.1.1、缺点</h4><p>这种实现方式代码耦合度高，用户服务的模块中出现了消息服务模块的代码，不利于系统的扩展和功能的迭代开发。</p>
<h3 id="2-2、发布-订阅机制"><a href="#2-2、发布-订阅机制" class="headerlink" title="2.2、发布/订阅机制"></a>2.2、发布/订阅机制</h3><h4 id="2-2-1、事件驱动"><a href="#2-2-1、事件驱动" class="headerlink" title="2.2.1、事件驱动"></a>2.2.1、事件驱动</h4><p>依然是上述的案例，用户服务在用户操作的过程中，需要调用消息服务的某个方法，假设为发送验证码消息的一个方法。为了使系统代码能够实现解耦，用户服务并不直接调用消息服务的具体的方法，而是将用户信息等相关数据发送到一个中间组件，该组件负责存储消息，而消息服务会按照特定的频率访问中间的消息存储组件，并取出其中的消息,然后执行发送验证码等操作。具体的示意图如下所示：<br><a href="/img/weifuwu/WX20190831-170056@2x.png" data-fancybox="group" data-caption="事件驱动" class="fancybox"><img alt="事件驱动" title="事件驱动" data-src="/img/weifuwu/WX20190831-170056@2x.png" class="lazyload"></a></p>
<p>在上述的架构图中，我们可以看到，相较于之前的实现，多了一个中间的消息组件系统。</p>
<h4 id="2-2-2、事件发布"><a href="#2-2-2、事件发布" class="headerlink" title="2.2.2、事件发布"></a>2.2.2、事件发布</h4><p>只有当用户服务中的某个功能执行时，才会触发相应的事件，并将对应的用户数据等消息发送到消息队列组件中，这个过程我们称之为事件发布。</p>
<h4 id="2-2-3、事件订阅"><a href="#2-2-3、事件订阅" class="headerlink" title="2.2.3、事件订阅"></a>2.2.3、事件订阅</h4><p>与事件发布对应的是事件订阅。我们增加消息队列组件的目的是实现模块程序的解耦，原来是程序调用端主动进行程序调用，现在需要由另外一方模块的程序到消息队列组件中主动获取需要相关数据并进行相关功能调用。这个主动获取的过程称之为订阅。</p>
<p>基于消息发布/订阅的消息系统有很多种框架的实现，常见的有：Kafka、RabbitMQ、ActiveMQ、Kestrel、NSQ 等。</p>
<h3 id="2-3、Broker"><a href="#2-3、Broker" class="headerlink" title="2.3、Broker"></a>2.3、Broker</h3><p>在我们介绍 go-micro 的时已经提到过，go-micro 整个框架都是插件式的设计。没错，这里的发布/订阅也是通过接口设计来实现的。</p>
<h4 id="2-3-1、定义"><a href="#2-3-1、定义" class="headerlink" title="2.3.1、定义"></a>2.3.1、定义</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Broker <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) error</span><br><span class="line">	Options() Options</span><br><span class="line">	Address() <span class="keyword">string</span></span><br><span class="line">	Connect() error</span><br><span class="line">	Disconnect() error</span><br><span class="line">	Publish(topic <span class="keyword">string</span>, m *Message, opts ...PublishOption) error</span><br><span class="line">	Subscribe(topic <span class="keyword">string</span>, h Handler, opts ...SubscribeOption) (Subscriber, error)</span><br><span class="line">	String() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果我们要具体实现事件的发布和订阅功能，只需要安装对应支持的 go-plugins 插件实现就可以了。go-plugins 里支持的消息队列方式有：kafka、nsq、rabbitmq、redis 等。同时，go-micro 本身支持三种 broker，分别是 http、nats、memory，默认的 broker 是 http，在实际使用过程中往往使用第三方的插件来进行消息发布/订阅的实现。</p>
<p>在本课程中，我们演示 RabbitMQ 插件实现的事件订阅和发布机制。</p>
<h3 id="2-4、安装-go-plugins"><a href="#2-4、安装-go-plugins" class="headerlink" title="2.4、安装 go-plugins"></a>2.4、安装 go-plugins</h3><p>在 go-micro 框架的学习过程中，需要频繁的用到相关的插件。因此，首先安装 go-plugins 插件库，在 go-plugins 插件库中，封装提供了 go-micro 框架中的插件机制的实现方案。</p>
<h4 id="2-4-1、源码库"><a href="#2-4-1、源码库" class="headerlink" title="2.4.1、源码库"></a>2.4.1、源码库</h4><p>在 github 网站上能够找到对应的 go-plugins 插件库的源码，源码地址是：<a href="https://github.com/micro/go-plugins" target="_blank" rel="noopener">https://github.com/micro/go-plugins</a></p>
<h4 id="2-4-2、安装"><a href="#2-4-2、安装" class="headerlink" title="2.4.2、安装"></a>2.4.2、安装</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/micro/<span class="keyword">go</span>-plugins</span><br></pre></td></tr></table></figure></div>

<p><a href="/img/weifuwu/WX20190902-162841@2x.png" data-fancybox="group" data-caption="go-plugins" class="fancybox"><img alt="go-plugins" title="go-plugins" data-src="/img/weifuwu/WX20190902-162841@2x.png" class="lazyload"></a><br>可以通过上述的命令安装 micro 的插件库，安装以后可以在当前系统的$GOPATH/src/github.com/micro 目录中找到对应的插件库源码。</p>
<h4 id="2-4-3、Broker-实现"><a href="#2-4-3、Broker-实现" class="headerlink" title="2.4.3、Broker 实现"></a>2.4.3、Broker 实现</h4><p>在已经安装和下载的 go-plugins 插件库中,我们可以看到有一个 broker 目录，其中就封装了 go-micro 框架的 broker 机制支持的解决方案。</p>
<p>我们在本案例中，以 mqtt 进行讲解。</p>
<h3 id="2-5、MQTT-介绍及环境搭建"><a href="#2-5、MQTT-介绍及环境搭建" class="headerlink" title="2.5、MQTT 介绍及环境搭建"></a>2.5、MQTT 介绍及环境搭建</h3><h4 id="2-5-1、MQTT-简介"><a href="#2-5-1、MQTT-简介" class="headerlink" title="2.5.1、MQTT 简介"></a>2.5.1、MQTT 简介</h4><p>MQTT 全称是 Message Queuing Telemetry Transport，翻译为消息队列遥测传输协议，是一种基于发布/订阅模式的”轻量级”的通讯协议，该协议基于 TCP/IP 协议，由 IBM 在 1999 年发布。MQTT 的最大优点在于，可以用极少的代码和有限的宽带,为连接远程设备提供提供实时可靠的消息服务。</p>
<h4 id="2-5-2、MQTT-安装"><a href="#2-5-2、MQTT-安装" class="headerlink" title="2.5.2、MQTT 安装"></a>2.5.2、MQTT 安装</h4><p>在 MacOS 系统下，安装 MQTT 的服务器 Mosquitto。可以在 MacOS 终端中使用命令进行安装：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mosquitto</span><br></pre></td></tr></table></figure></div>

<h4 id="2-5-3、运行-mosquitto"><a href="#2-5-3、运行-mosquitto" class="headerlink" title="2.5.3、运行 mosquitto"></a>2.5.3、运行 mosquitto</h4><p>在 MacOS 系统中安装成功以后，可以通过命令进行启动 mosquitto，具体操作命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$cd &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">$.&#x2F;sbin&#x2F;mosquitto -c etc&#x2F;mosquitto&#x2F;mosquitto.conf -d -v</span><br></pre></td></tr></table></figure></div>

<p>启动成功后，会在终端中有如下所示的日志输出：<br><a href="/img/weifuwu/WX20190903-140930@2x.png" data-fancybox="group" data-caption="启动mosquitto" class="fancybox"><img alt="启动mosquitto" title="启动mosquitto" data-src="/img/weifuwu/WX20190903-140930@2x.png" class="lazyload"></a><br>出现如上图所示的输出内容，即表示 mqtt 启动成功。</p>
<p>windows 系统上的 mqtt 的安装和启动，可以到<a href="https://activemq.apache.org/" target="_blank" rel="noopener">https://activemq.apache.org/</a>中下载最新的安装文件，然后进行安装和运行。</p>
<h3 id="2-6、编程实现"><a href="#2-6、编程实现" class="headerlink" title="2.6、编程实现"></a>2.6、编程实现</h3><p>接下来进行订阅和发布机制的编程的实现。</p>
<h4 id="2-6-1、消息组件初始化"><a href="#2-6-1、消息组件初始化" class="headerlink" title="2.6.1、消息组件初始化"></a>2.6.1、消息组件初始化</h4><p>如果要想使用消息组件完成消息的发布和订阅，首先应该让消息组件正常工作。因此，需要先对消息组件进行初始化。我们可以在服务创建时，对消息组件进行初始化，并进行可选项配置,设置使用 mqtt 作为消息组件。代码实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">server := micro.NewService(</span><br><span class="line">		micro.Name(<span class="string">"go.micro.srv"</span>),</span><br><span class="line">		micro.Version(<span class="string">"latest"</span>),</span><br><span class="line">		micro.Broker(mqtt.NewBroker()),</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>可以使用 micro.Broker 来指定特定的消息组件，并通过 mqtt.NewBroker 初始化一个 mqtt 实例对象,作为 broker 参数。</p>
<h4 id="2-6-2、消息订阅"><a href="#2-6-2、消息订阅" class="headerlink" title="2.6.2、消息订阅"></a>2.6.2、消息订阅</h4><p>因为是时间驱动机制，消息的发送方随时可能发布相关事件。因此需要消息的接收方先进行订阅操作，避免遗漏消息。go-micro 框架中可以通过 broker.Subscribe 实现消息订阅。编程代码如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">pubSub := service.Server().Options().Broker</span><br><span class="line">_, err := pubSub.Subscribe(<span class="string">"go.micro.srv.message"</span>, <span class="function"><span class="keyword">func</span><span class="params">(event broker.Event)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> req *message.StudentRequest</span><br><span class="line">		<span class="keyword">if</span> err := json.Unmarshal(event.Message().Body, &amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">" 接收到信息："</span>, req)</span><br><span class="line">		<span class="comment">//去执行其他操作</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<h4 id="2-6-3、消息发布"><a href="#2-6-3、消息发布" class="headerlink" title="2.6.3、消息发布"></a>2.6.3、消息发布</h4><p>完成了消息的订阅，我们再来实现消息的发布。在客户端实现消息的发布。在 go-micro 框架中，可以使用 broker.Publish 来进行消息的发布,具体的代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">brok := service.Server().Options().Broker</span><br><span class="line"><span class="keyword">if</span> err := brok.Connect(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Fatal(<span class="string">" broker connection failed, error : "</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">student := &amp;message.Student&#123;Name: <span class="string">"davie"</span>, Classes: <span class="string">"软件工程专业"</span>, Grade: <span class="number">80</span>, Phone: <span class="string">"12345678901"</span>&#125;</span><br><span class="line">msgBody, err := json.Marshal(student)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Fatal(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">msg := &amp;broker.Message&#123;</span><br><span class="line">	Header: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"name"</span>: student.Name,</span><br><span class="line">	&#125;,</span><br><span class="line">	Body: msgBody,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = brok.Publish(<span class="string">"go.micro.srv.message"</span>, msg)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Fatal(<span class="string">" 消息发布失败：%s\n"</span>, err.Error())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	log.Print(<span class="string">"消息发布成功"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<h3 id="2-7、运行程序"><a href="#2-7、运行程序" class="headerlink" title="2.7、运行程序"></a>2.7、运行程序</h3><h4 id="2-7-1、启动-mqtt-服务器"><a href="#2-7-1、启动-mqtt-服务器" class="headerlink" title="2.7.1、启动 mqtt 服务器"></a>2.7.1、启动 mqtt 服务器</h4><p>mqtt 服务器默认会在 1883 端口进行监听。</p>
<h4 id="2-7-2、启动-server-程序"><a href="#2-7-2、启动-server-程序" class="headerlink" title="2.7.2、启动 server 程序"></a>2.7.2、启动 server 程序</h4><p>首先运行 server 端程序的 main.go 文件中的 main 函数。</p>
<h4 id="2-7-3、错误"><a href="#2-7-3、错误" class="headerlink" title="2.7.3、错误"></a>2.7.3、错误</h4><p>在运行 main.go 程序时，会报如下错误：cannot find package “github.com/eclipse/paho.mqtt.golang”：<br><a href="/img/weifuwu/WX20190903-113613@2x.png" data-fancybox="group" data-caption="错误" class="fancybox"><img alt="错误" title="错误" data-src="/img/weifuwu/WX20190903-113613@2x.png" class="lazyload"></a></p>
<p>需要我们安装对应的包源码，该包的源码地址在 github 地址代码库中：<a href="https://github.com/eclipse/paho.mqtt.golang" target="_blank" rel="noopener">https://github.com/eclipse/paho.mqtt.golang</a>，安装命令如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/eclipse/paho.mqtt.golang</span><br></pre></td></tr></table></figure></div>

<p>包安装后，可以执行 server.go 文件中的 main 函数，启动程序如下：<br><a href="/img/weifuwu/WX20190903-145638@2x.png" data-fancybox="group" data-caption="server.go函数" class="fancybox"><img alt="server.go函数" title="server.go函数" data-src="/img/weifuwu/WX20190903-145638@2x.png" class="lazyload"></a></p>
<h4 id="2-7-4、启动-client-程序"><a href="#2-7-4、启动-client-程序" class="headerlink" title="2.7.4、启动 client 程序"></a>2.7.4、启动 client 程序</h4><p>server 程序启动后，启动客户端程序 client.go，可以输出正确日志。另外可以在 mqtt 终端中输出相关的消息订阅和发布的日志，如下图所示：<br><a href="/img/weifuwu/WX20190903-150034@2x.png" data-fancybox="group" data-caption="mqtt日志" class="fancybox"><img alt="mqtt日志" title="mqtt日志" data-src="/img/weifuwu/WX20190903-150034@2x.png" class="lazyload"></a></p>
<h3 id="2-8、弊端"><a href="#2-8、弊端" class="headerlink" title="2.8、弊端"></a>2.8、弊端</h3><p>在服务端通过 fmt.println 日志，可以输出 event.Message().Body)数据，其格式为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;name&quot;:&quot;davie&quot;,&quot;classes&quot;:&quot;软件工程专业&quot;,&quot;grade&quot;:80,&quot;phone&quot;:&quot;12345678901&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到在服务实例之间传输的数据格式是 json 格式。根据之前学习 proto 知识可以知道，在进行消息通信时，采用 JSON 格式进行数据传输，其效率比较低。</p>
<p>因此，这意味着，当我们在使用第三方消息组件进行消息发布/订阅时，会失去对 protobuf 的使用。这对追求高消息的开发者而言，是需要解决和改进的问题。因为使用 protobuf 可以直接在多个服务之间使用二进制流数据进行传输，要比 json 格式高效的多。</p>
<h3 id="2-9、googlepubsub"><a href="#2-9、googlepubsub" class="headerlink" title="2.9、googlepubsub"></a>2.9、googlepubsub</h3><p>在 go-micro 框架中内置的 Broker 插件中，有 google 提供的 googlepubsub 插件实现，位于代理层之上，同时还省略了使用第三方代理消息组件（如 mqtt)。</p>
<p>参考资料：<a href="https://cloud.google.com/pubsub/" target="_blank" rel="noopener">https://cloud.google.com/pubsub/</a>。感兴趣的同学可以自己动手实现，此处我们作为拓展思路，不再进行实现。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">wangguangatap</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wangguangatap.github.io/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%B8%80)/">https://wangguangatap.github.io/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%B8%80)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://wangguangatap.github.io/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wangguangatap.github.io">星脉</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang    </a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务    </a></div><div class="post_share"><div class="social-share" data-image="/img/weifuwu/weifuwu.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/01/27/go-micro%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/"><img class="prev_cover lazyload" data-src="/img/weifuwu/weifuwu.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>微服务：(七)go-micro框架介绍</span></div></a></div><div class="next-post pull_right"><a href="/2020/01/27/go-micro%E4%BD%BF%E7%94%A8(%E4%BA%8C)/"><img class="next_cover lazyload" data-src="/img/weifuwu/weifuwu.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>微服务：(八)go-micro使用(二)</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/27/wei/" title="微服务"><img class="relatedPosts_cover lazyload"data-src="/img/golang/golang.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务简介及特性介绍/" title="微服务：(一)微服务简介及特性介绍"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(一)微服务简介及特性介绍</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/Protobuf介绍/" title="微服务：(二)Protobuf介绍"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(二)Protobuf介绍</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务管理(上)/" title="微服务：(二)微服务管理(上)"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(二)微服务管理(上)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务管理(下)/" title="微服务：(三)微服务管理(下)"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(三)微服务管理(下)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/RPC远程过程调用/" title="微服务：(四)RPC远程过程调用"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(四)RPC远程过程调用</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By wangguangatap</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>