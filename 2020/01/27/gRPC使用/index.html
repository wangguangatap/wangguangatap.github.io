<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>微服务：(六)gRPC 编程使用 | 星脉</title><meta name="description" content="微服务：(六)gRPC 编程使用"><meta name="keywords" content="Golang,微服务,gRPC"><meta name="author" content="wangguangatap"><meta name="copyright" content="wangguangatap"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="微服务：(六)gRPC 编程使用"><meta name="twitter:description" content="微服务：(六)gRPC 编程使用"><meta name="twitter:image" content="https://wangguangatap.github.io/img/weifuwu/weifuwu.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="微服务：(六)gRPC 编程使用"><meta property="og:url" content="https://wangguangatap.github.io/2020/01/27/gRPC%E4%BD%BF%E7%94%A8/"><meta property="og:site_name" content="星脉"><meta property="og:description" content="微服务：(六)gRPC 编程使用"><meta property="og:image" content="https://wangguangatap.github.io/img/weifuwu/weifuwu.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wangguangatap.github.io/2020/01/27/gRPC%E4%BD%BF%E7%94%A8/"><link rel="prev" title="微服务：(五)gRPC远程调用机制介绍" href="https://wangguangatap.github.io/2020/01/27/gRPC%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D/"><link rel="next" title="微服务：(七)go-micro框架介绍" href="https://wangguangatap.github.io/2020/01/27/go-micro%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">星脉</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">74</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">30</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#gRPC-编程使用"><span class="toc_mobile_items-text">gRPC 编程使用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一、gRPC-调用"><span class="toc_mobile_items-text">一、gRPC 调用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1、服务端流-RPC"><span class="toc_mobile_items-text">1.1、服务端流 RPC</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-1、服务接口定义"><span class="toc_mobile_items-text">1.1.1、服务接口定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-2-编译-proto-文件，生成-pb-go-文件"><span class="toc_mobile_items-text">1.1.2 编译.proto 文件，生成 pb.go 文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-3-自动生成文件的变化"><span class="toc_mobile_items-text">1.1.3 自动生成文件的变化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-1-3-1-服务端自动生成"><span class="toc_mobile_items-text">1.1.3.1 服务端自动生成</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-1-3-2-客户端自动生成"><span class="toc_mobile_items-text">1.1.3.2 客户端自动生成</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-4-服务编码实现"><span class="toc_mobile_items-text">1.1.4 服务编码实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-5-服务的注册和监听的处理"><span class="toc_mobile_items-text">1.1.5 服务的注册和监听的处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-6-客户端数据接收"><span class="toc_mobile_items-text">1.1.6 客户端数据接收</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-1-7-运行结果"><span class="toc_mobile_items-text">1.1.7 运行结果</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-1-7-1-服务端运行结果"><span class="toc_mobile_items-text">1.1.7.1 服务端运行结果</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-1-7-2-客户端运行结果"><span class="toc_mobile_items-text">1.1.7.2 客户端运行结果</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-2、客户端流模式"><span class="toc_mobile_items-text">1.2、客户端流模式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-1-服务接口的定义"><span class="toc_mobile_items-text">1.2.1 服务接口的定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-2-编译-proto-文件"><span class="toc_mobile_items-text">1.2.2 编译.proto 文件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-2-2-1-自动生成的服务流接口实现"><span class="toc_mobile_items-text">1.2.2.1 自动生成的服务流接口实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-2-2-2-自动生成的客户端流接口实现"><span class="toc_mobile_items-text">1.2.2.2 自动生成的客户端流接口实现</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-3-服务的实现"><span class="toc_mobile_items-text">1.2.3 服务的实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-4-服务的注册和监听处理"><span class="toc_mobile_items-text">1.2.4 服务的注册和监听处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-5-客户端实现"><span class="toc_mobile_items-text">1.2.5 客户端实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-2-6-程序运行"><span class="toc_mobile_items-text">1.2.6 程序运行</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-2-6-1-服务端"><span class="toc_mobile_items-text">1.2.6.1 服务端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-2-6-2-客户端"><span class="toc_mobile_items-text">1.2.6.2 客户端</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-3、双向流模式"><span class="toc_mobile_items-text">1.3、双向流模式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-1-双向流服务的定义"><span class="toc_mobile_items-text">1.3.1 双向流服务的定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-2-编译-proto-文件"><span class="toc_mobile_items-text">1.3.2 编译.proto 文件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-3-2-1-服务端接口实现"><span class="toc_mobile_items-text">1.3.2.1 服务端接口实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-3-2-2-客户端接口实现"><span class="toc_mobile_items-text">1.3.2.2 客户端接口实现</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-3-服务实现"><span class="toc_mobile_items-text">1.3.3 服务实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-4-服务端及客户端的编程实现"><span class="toc_mobile_items-text">1.3.4 服务端及客户端的编程实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-3-4-1-服务端实现"><span class="toc_mobile_items-text">1.3.4.1 服务端实现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#1-3-4-2-客户端实现"><span class="toc_mobile_items-text">1.3.4.2 客户端实现</span></a></li></ol></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二、TLS-验证和-Token-认证"><span class="toc_mobile_items-text">二、TLS 验证和 Token 认证</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-1-授权认证"><span class="toc_mobile_items-text">2.1 授权认证</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-1-SSL-TLS-认证方式"><span class="toc_mobile_items-text">2.1.1 SSL&#x2F;TLS 认证方式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-1-1-SSL-TLS-工作原理"><span class="toc_mobile_items-text">2.1.1.1 SSL&#x2F;TLS 工作原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-1-2-制作证书"><span class="toc_mobile_items-text">2.1.1.2 制作证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-1-3-编程实现服务端"><span class="toc_mobile_items-text">2.1.1.3 编程实现服务端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-1-3-编程实现客户端"><span class="toc_mobile_items-text">2.1.1.3 编程实现客户端</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#2-1-2-基于-Token-认证方式"><span class="toc_mobile_items-text">2.1.2 基于 Token 认证方式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-2-1-Token-认证介绍"><span class="toc_mobile_items-text">2.1.2.1 Token 认证介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-2-2-Token-认证过程"><span class="toc_mobile_items-text">2.1.2.2 Token 认证过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-2-3-gRPC-的自定义-Token-认证"><span class="toc_mobile_items-text">2.1.2.3 gRPC 的自定义 Token 认证</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#2-1-2-4-服务端"><span class="toc_mobile_items-text">2.1.2.4 服务端</span></a></li></ol></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三、拦截器的使用"><span class="toc_mobile_items-text">三、拦截器的使用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-1、需求"><span class="toc_mobile_items-text">3.1、需求</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-2、Interceptor"><span class="toc_mobile_items-text">3.2、Interceptor</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-3、自定义-UnaryServerInterceptor"><span class="toc_mobile_items-text">3.3、自定义 UnaryServerInterceptor</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4、拦截器注册"><span class="toc_mobile_items-text">3.4、拦截器注册</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-5、项目运行"><span class="toc_mobile_items-text">3.5、项目运行</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#四-日志"><span class="toc_mobile_items-text">四. 日志</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#五-gRPC-错误处理"><span class="toc_mobile_items-text">五. gRPC 错误处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#六-日期转换"><span class="toc_mobile_items-text">六.日期转换</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#七-配置"><span class="toc_mobile_items-text">七.配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#八-web-验证错误信息"><span class="toc_mobile_items-text">八.web 验证错误信息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#九-JWT"><span class="toc_mobile_items-text">九. JWT</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#十-跨域"><span class="toc_mobile_items-text">十. 跨域</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#十一-动态获取端口"><span class="toc_mobile_items-text">十一. 动态获取端口</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#十二-服务注册与发现"><span class="toc_mobile_items-text">十二. 服务注册与发现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#十三-负载均衡"><span class="toc_mobile_items-text">十三. 负载均衡</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#十四-Nacos-配置中心"><span class="toc_mobile_items-text">十四. Nacos 配置中心</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#gRPC-编程使用"><span class="toc-text">gRPC 编程使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、gRPC-调用"><span class="toc-text">一、gRPC 调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、服务端流-RPC"><span class="toc-text">1.1、服务端流 RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1、服务接口定义"><span class="toc-text">1.1.1、服务接口定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-编译-proto-文件，生成-pb-go-文件"><span class="toc-text">1.1.2 编译.proto 文件，生成 pb.go 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-自动生成文件的变化"><span class="toc-text">1.1.3 自动生成文件的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3-1-服务端自动生成"><span class="toc-text">1.1.3.1 服务端自动生成</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3-2-客户端自动生成"><span class="toc-text">1.1.3.2 客户端自动生成</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-4-服务编码实现"><span class="toc-text">1.1.4 服务编码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-5-服务的注册和监听的处理"><span class="toc-text">1.1.5 服务的注册和监听的处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-6-客户端数据接收"><span class="toc-text">1.1.6 客户端数据接收</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-7-运行结果"><span class="toc-text">1.1.7 运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-7-1-服务端运行结果"><span class="toc-text">1.1.7.1 服务端运行结果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-7-2-客户端运行结果"><span class="toc-text">1.1.7.2 客户端运行结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、客户端流模式"><span class="toc-text">1.2、客户端流模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-服务接口的定义"><span class="toc-text">1.2.1 服务接口的定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-编译-proto-文件"><span class="toc-text">1.2.2 编译.proto 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-1-自动生成的服务流接口实现"><span class="toc-text">1.2.2.1 自动生成的服务流接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-2-自动生成的客户端流接口实现"><span class="toc-text">1.2.2.2 自动生成的客户端流接口实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-服务的实现"><span class="toc-text">1.2.3 服务的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-服务的注册和监听处理"><span class="toc-text">1.2.4 服务的注册和监听处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-客户端实现"><span class="toc-text">1.2.5 客户端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-6-程序运行"><span class="toc-text">1.2.6 程序运行</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-6-1-服务端"><span class="toc-text">1.2.6.1 服务端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-6-2-客户端"><span class="toc-text">1.2.6.2 客户端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3、双向流模式"><span class="toc-text">1.3、双向流模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-双向流服务的定义"><span class="toc-text">1.3.1 双向流服务的定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-编译-proto-文件"><span class="toc-text">1.3.2 编译.proto 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2-1-服务端接口实现"><span class="toc-text">1.3.2.1 服务端接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-2-2-客户端接口实现"><span class="toc-text">1.3.2.2 客户端接口实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-服务实现"><span class="toc-text">1.3.3 服务实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-服务端及客户端的编程实现"><span class="toc-text">1.3.4 服务端及客户端的编程实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4-1-服务端实现"><span class="toc-text">1.3.4.1 服务端实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-3-4-2-客户端实现"><span class="toc-text">1.3.4.2 客户端实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、TLS-验证和-Token-认证"><span class="toc-text">二、TLS 验证和 Token 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-授权认证"><span class="toc-text">2.1 授权认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-SSL-TLS-认证方式"><span class="toc-text">2.1.1 SSL&#x2F;TLS 认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-1-SSL-TLS-工作原理"><span class="toc-text">2.1.1.1 SSL&#x2F;TLS 工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-2-制作证书"><span class="toc-text">2.1.1.2 制作证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-3-编程实现服务端"><span class="toc-text">2.1.1.3 编程实现服务端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-3-编程实现客户端"><span class="toc-text">2.1.1.3 编程实现客户端</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-基于-Token-认证方式"><span class="toc-text">2.1.2 基于 Token 认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-1-Token-认证介绍"><span class="toc-text">2.1.2.1 Token 认证介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-2-Token-认证过程"><span class="toc-text">2.1.2.2 Token 认证过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-3-gRPC-的自定义-Token-认证"><span class="toc-text">2.1.2.3 gRPC 的自定义 Token 认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-4-服务端"><span class="toc-text">2.1.2.4 服务端</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、拦截器的使用"><span class="toc-text">三、拦截器的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、需求"><span class="toc-text">3.1、需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、Interceptor"><span class="toc-text">3.2、Interceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3、自定义-UnaryServerInterceptor"><span class="toc-text">3.3、自定义 UnaryServerInterceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4、拦截器注册"><span class="toc-text">3.4、拦截器注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5、项目运行"><span class="toc-text">3.5、项目运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四-日志"><span class="toc-text">四. 日志</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五-gRPC-错误处理"><span class="toc-text">五. gRPC 错误处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六-日期转换"><span class="toc-text">六.日期转换</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七-配置"><span class="toc-text">七.配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#八-web-验证错误信息"><span class="toc-text">八.web 验证错误信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#九-JWT"><span class="toc-text">九. JWT</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十-跨域"><span class="toc-text">十. 跨域</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十一-动态获取端口"><span class="toc-text">十一. 动态获取端口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十二-服务注册与发现"><span class="toc-text">十二. 服务注册与发现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十三-负载均衡"><span class="toc-text">十三. 负载均衡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十四-Nacos-配置中心"><span class="toc-text">十四. Nacos 配置中心</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/img/weifuwu/weifuwu.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">微服务：(六)gRPC 编程使用</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-01-27<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2021-05-15</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="gRPC-编程使用"><a href="#gRPC-编程使用" class="headerlink" title="gRPC 编程使用"></a>gRPC 编程使用</h1><h2 id="一、gRPC-调用"><a href="#一、gRPC-调用" class="headerlink" title="一、gRPC 调用"></a>一、gRPC 调用</h2><p>在上节课内容中，我们学习了使用 gRPC 框架实现服务的调用编程。在 gRPC 框架中，诸如上节课我们学习的在客户端与服务端之间通过消息结构体定义的方式来传递数据，我们称之为“单项 RPC”，也称之为简单模式。除此之外，gRPC 中还有数据流模式的 RPC 调用实现，这正是我们本节课要学习的内容。</p>
<h3 id="1-1、服务端流-RPC"><a href="#1-1、服务端流-RPC" class="headerlink" title="1.1、服务端流 RPC"></a>1.1、服务端流 RPC</h3><p>在服务端流模式的 RPC 实现中，服务端得到客户端请求后，处理结束返回一个数据应答流。在发送完所有的客户端请求的应答数据后，服务端的状态详情和可选的跟踪元数据发送给客户端。服务端流 RPC 实现案例如下：</p>
<h4 id="1-1-1、服务接口定义"><a href="#1-1-1、服务接口定义" class="headerlink" title="1.1.1、服务接口定义"></a>1.1.1、服务接口定义</h4><p>在.proto 文件中定义服务接口,使用服务端流模式定义服务接口,如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">&#x2F;&#x2F;订单服务service定义</span><br><span class="line">service OrderService &#123;</span><br><span class="line">    rpc GetOrderInfos (OrderRequest) returns (stream OrderInfo) &#123;&#125;; &#x2F;&#x2F;服务端流模式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以看到与之前简单模式下的数据作为服务接口的参数和返回值不同的是，此处服务接口的返回值使用了 stream 进行修饰。通过 stream 修饰的方式表示该接口调用时，服务端会以数据流的形式将数据返回给客户端。</p>
<h4 id="1-1-2-编译-proto-文件，生成-pb-go-文件"><a href="#1-1-2-编译-proto-文件，生成-pb-go-文件" class="headerlink" title="1.1.2 编译.proto 文件，生成 pb.go 文件"></a>1.1.2 编译.proto 文件，生成 pb.go 文件</h4><p>使用 gRPC 插件编译命令编译.proto 文件，编译命令如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">protoc --go_out=plugins=grpc:. message.proto</span><br></pre></td></tr></table></figure></div>

<h4 id="1-1-3-自动生成文件的变化"><a href="#1-1-3-自动生成文件的变化" class="headerlink" title="1.1.3 自动生成文件的变化"></a>1.1.3 自动生成文件的变化</h4><p>与数据结构体发送携带数据实现不同的时，流模式下的数据发送和接收使用新的功能方法完成。在自动生成的 go 代码程序当中，每一个流模式对应的服务接口，都会自动生成对应的单独的 client 和 server 程序，以及对应的结构体实现。具体编程如下图所示：</p>
<h5 id="1-1-3-1-服务端自动生成"><a href="#1-1-3-1-服务端自动生成" class="headerlink" title="1.1.3.1 服务端自动生成"></a>1.1.3.1 服务端自动生成</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_GetOrderInfosServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Send(*OrderInfo) error</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceGetOrderInfosServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosServer)</span> <span class="title">Send</span><span class="params">(m *OrderInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x.ServerStream.SendMsg(m)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>流模式下，服务接口的服务端提供 Send 方法，将数据以流的形式进行发送</p>
<h5 id="1-1-3-2-客户端自动生成"><a href="#1-1-3-2-客户端自动生成" class="headerlink" title="1.1.3.2 客户端自动生成"></a>1.1.3.2 客户端自动生成</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_GetOrderInfosClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	Recv() (*OrderInfo, error)</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceGetOrderInfosClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosClient)</span> <span class="title">Recv</span><span class="params">()</span> <span class="params">(*OrderInfo, error)</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">new</span>(OrderInfo)</span><br><span class="line">	<span class="keyword">if</span> err := x.ClientStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>流模式下，服务接口的客户端提供 Recv()方法接收服务端发送的流数据。</p>
<h4 id="1-1-4-服务编码实现"><a href="#1-1-4-服务编码实现" class="headerlink" title="1.1.4 服务编码实现"></a>1.1.4 服务编码实现</h4><p>定义好服务接口并编译生成代码文件后，即可根据规则对定义的服务进行编码实现。具体的服务编码实现如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//订单服务实现</span></span><br><span class="line"><span class="keyword">type</span> OrderServiceImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取订单信息s</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(os *OrderServiceImpl)</span> <span class="title">GetOrderInfos</span><span class="params">(request *message.OrderRequest, stream message.OrderService_GetOrderInfosServer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">" 服务端流 RPC 模式"</span>)</span><br><span class="line"></span><br><span class="line">	orderMap := <span class="keyword">map</span>[<span class="keyword">string</span>]message.OrderInfo&#123;</span><br><span class="line">		<span class="string">"201907300001"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907300001"</span>, OrderName: <span class="string">"衣服"</span>, OrderStatus: <span class="string">"已付款"</span>&#125;,</span><br><span class="line">		<span class="string">"201907310001"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907310001"</span>, OrderName: <span class="string">"零食"</span>, OrderStatus: <span class="string">"已付款"</span>&#125;,</span><br><span class="line">		<span class="string">"201907310002"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907310002"</span>, OrderName: <span class="string">"食品"</span>, OrderStatus: <span class="string">"未付款"</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> id, info := <span class="keyword">range</span> orderMap &#123;</span><br><span class="line">		<span class="keyword">if</span> (time.Now().Unix() &gt;= request.TimeStamp) &#123;</span><br><span class="line">			fmt.Println(<span class="string">"订单序列号ID："</span>, id)</span><br><span class="line">			fmt.Println(<span class="string">"订单详情："</span>, info)</span><br><span class="line">			<span class="comment">//通过流模式发送给客户端</span></span><br><span class="line">			stream.Send(&amp;info)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>GetOrderInfos 方法就是服务接口的具体实现，因为是流模式开发，服务端将数据以流的形式进行发送,因此，该方法的第二个参数类型为 OrderService_GetOrderInfosServer，该参数类型是一个接口，其中包含 Send 方法，允许发送流数据。Send 方法的具体实现在编译好的 pb.go 文件中，进一步调用 grpc.SeverStream.SendMsg 方法。</p>
<h4 id="1-1-5-服务的注册和监听的处理"><a href="#1-1-5-服务的注册和监听的处理" class="headerlink" title="1.1.5 服务的注册和监听的处理"></a>1.1.5 服务的注册和监听的处理</h4><p>服务的监听与处理与前文所学内容没有区别，依然是相同的步骤:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := grpc.NewServer()</span><br><span class="line">	<span class="comment">//注册</span></span><br><span class="line">	message.RegisterOrderServiceServer(server, <span class="built_in">new</span>(OrderServiceImpl))</span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8090"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	server.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-1-6-客户端数据接收"><a href="#1-1-6-客户端数据接收" class="headerlink" title="1.1.6 客户端数据接收"></a>1.1.6 客户端数据接收</h4><p>服务端使用 Send 方法将数据以流的形式进行发送，客户端可以使用 Recv()方法接收流数据,因为数据流失源源不断的，因此使用 for 无限循环实现数据流的读取，当读取到 io.EOF 时，表示流数据结束。客户端数据读取实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">		orderInfo, err := orderInfoClient.Recv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(<span class="string">"读取结束"</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">"读取到的信息："</span>, orderInfo)</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<h4 id="1-1-7-运行结果"><a href="#1-1-7-运行结果" class="headerlink" title="1.1.7 运行结果"></a>1.1.7 运行结果</h4><p>按照先后顺序，依次运行 server.go 文件和 client.go 文件，可以得到运行结果。</p>
<h5 id="1-1-7-1-服务端运行结果"><a href="#1-1-7-1-服务端运行结果" class="headerlink" title="1.1.7.1 服务端运行结果"></a>1.1.7.1 服务端运行结果</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> 服务端流 RPC 模式</span><br><span class="line">订单序列号ID： <span class="number">201907300001</span></span><br><span class="line">订单详情： &#123;<span class="number">201907300001</span> 衣服 已付款 &#123;&#125; [] <span class="number">0</span>&#125;</span><br><span class="line">订单序列号ID： <span class="number">201907310001</span></span><br><span class="line">订单详情： &#123;<span class="number">201907310001</span> 零食 已付款 &#123;&#125; [] <span class="number">0</span>&#125;</span><br><span class="line">订单序列号ID： <span class="number">201907310002</span></span><br><span class="line">订单详情： &#123;<span class="number">201907310002</span> 食品 未付款 &#123;&#125; [] <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="1-1-7-2-客户端运行结果"><a href="#1-1-7-2-客户端运行结果" class="headerlink" title="1.1.7.2 客户端运行结果"></a>1.1.7.2 客户端运行结果</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">客户端请求RPC调用：服务端流模式</span><br><span class="line">读取到的信息： OrderId:<span class="string">"201907310001"</span> OrderName:<span class="string">"\351\233\266\351\243\237"</span> OrderStatus:<span class="string">"\345\267\262\344\273\230\346\254\276"</span></span><br><span class="line">读取到的信息： OrderId:<span class="string">"201907310002"</span> OrderName:<span class="string">"\351\243\237\345\223\201"</span> OrderStatus:<span class="string">"\346\234\252\344\273\230\346\254\276"</span></span><br><span class="line">读取到的信息： OrderId:<span class="string">"201907300001"</span> OrderName:<span class="string">"\350\241\243\346\234\215"</span> OrderStatus:<span class="string">"\345\267\262\344\273\230\346\254\276"</span></span><br><span class="line">读取结束</span><br></pre></td></tr></table></figure></div>

<h3 id="1-2、客户端流模式"><a href="#1-2、客户端流模式" class="headerlink" title="1.2、客户端流模式"></a>1.2、客户端流模式</h3><p>上文演示的是服务端以数据流的形式返回数据的形式。对应的，也存在客户端以流的形式发送请求数据的形式。</p>
<h4 id="1-2-1-服务接口的定义"><a href="#1-2-1-服务接口的定义" class="headerlink" title="1.2.1 服务接口的定义"></a>1.2.1 服务接口的定义</h4><p>与服务端同理,客户端流模式的 RPC 服务声明格式，就是使用 stream 修饰服务接口的接收参数,具体如下所示:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">&#x2F;&#x2F;订单服务service定义</span><br><span class="line">service OrderService &#123;</span><br><span class="line">    rpc AddOrderList (stream OrderRequest) returns (OrderInfo) &#123;&#125;; &#x2F;&#x2F;客户端流模式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-2-2-编译-proto-文件"><a href="#1-2-2-编译-proto-文件" class="headerlink" title="1.2.2 编译.proto 文件"></a>1.2.2 编译.proto 文件</h4><p>使用编译命令编译.protow 文件。客户端流模式中也会自动生成服务接口的接口。</p>
<h5 id="1-2-2-1-自动生成的服务流接口实现"><a href="#1-2-2-1-自动生成的服务流接口实现" class="headerlink" title="1.2.2.1 自动生成的服务流接口实现"></a>1.2.2.1 自动生成的服务流接口实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_AddOrderListServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	SendAndClose(*OrderInfo) error</span><br><span class="line">	Recv() (*OrderRequest, error)</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceAddOrderListServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceAddOrderListServer)</span> <span class="title">SendAndClose</span><span class="params">(m *OrderInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x.ServerStream.SendMsg(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceAddOrderListServer)</span> <span class="title">Recv</span><span class="params">()</span> <span class="params">(*OrderRequest, error)</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">new</span>(OrderRequest)</span><br><span class="line">	<span class="keyword">if</span> err := x.ServerStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>SendAndClose 和 Recv 方法是客户端流模式下的服务端对象所拥有的方法。</p>
<h5 id="1-2-2-2-自动生成的客户端流接口实现"><a href="#1-2-2-2-自动生成的客户端流接口实现" class="headerlink" title="1.2.2.2 自动生成的客户端流接口实现"></a>1.2.2.2 自动生成的客户端流接口实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_AddOrderListClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	Send(*OrderRequest) error</span><br><span class="line">	CloseAndRecv() (*OrderInfo, error)</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceAddOrderListClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceAddOrderListClient)</span> <span class="title">Send</span><span class="params">(m *OrderRequest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x.ClientStream.SendMsg(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceAddOrderListClient)</span> <span class="title">CloseAndRecv</span><span class="params">()</span> <span class="params">(*OrderInfo, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := x.ClientStream.CloseSend(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	m := <span class="built_in">new</span>(OrderInfo)</span><br><span class="line">	<span class="keyword">if</span> err := x.ClientStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Send 和 CloseAndRecv 是客户端流模式下的客户端对象所拥有的方法。</p>
<h4 id="1-2-3-服务的实现"><a href="#1-2-3-服务的实现" class="headerlink" title="1.2.3 服务的实现"></a>1.2.3 服务的实现</h4><p>客户端流模式的服务接口具体实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//订单服务实现</span></span><br><span class="line"><span class="keyword">type</span> OrderServiceImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加订单信息服务实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(os *OrderServiceImpl)</span> <span class="title">AddOrderList</span><span class="params">(stream message.OrderService_AddOrderListServer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">" 客户端流 RPC 模式"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">//从流中读取数据信息</span></span><br><span class="line">		orderRequest, err := stream.Recv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(<span class="string">" 读取数据结束 "</span>)</span><br><span class="line">			result := message.OrderInfo&#123;OrderStatus: <span class="string">" 读取数据结束 "</span>&#125;</span><br><span class="line">			<span class="keyword">return</span> stream.SendAndClose(&amp;result)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err.Error())</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//打印接收到的数据</span></span><br><span class="line">		fmt.Println(orderRequest)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-2-4-服务的注册和监听处理"><a href="#1-2-4-服务的注册和监听处理" class="headerlink" title="1.2.4 服务的注册和监听处理"></a>1.2.4 服务的注册和监听处理</h4><p>依然是采用相同的服务注册和监听处理方式对服务进行注册和监听处理。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	server := grpc.NewServer()</span><br><span class="line">	<span class="comment">//注册</span></span><br><span class="line">	message.RegisterOrderServiceServer(server, <span class="built_in">new</span>(OrderServiceImpl))</span><br><span class="line"></span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8090"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	server.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-2-5-客户端实现"><a href="#1-2-5-客户端实现" class="headerlink" title="1.2.5 客户端实现"></a>1.2.5 客户端实现</h4><p>客户端调用 send 方法流数据到服务端，具体实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//调用服务方法</span></span><br><span class="line">	addOrderListClient, err := orderServiceClient.AddOrderList(context.Background())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//调用方法发送流数据</span></span><br><span class="line">	<span class="keyword">for</span> _, info := <span class="keyword">range</span> orderMap &#123;</span><br><span class="line">		err = addOrderListClient.Send(&amp;info)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		orderInfo, err := addOrderListClient.CloseAndRecv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(<span class="string">" 读取数据结束了 "</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(orderInfo.GetOrderStatus())</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-2-6-程序运行"><a href="#1-2-6-程序运行" class="headerlink" title="1.2.6 程序运行"></a>1.2.6 程序运行</h4><h5 id="1-2-6-1-服务端"><a href="#1-2-6-1-服务端" class="headerlink" title="1.2.6.1 服务端"></a>1.2.6.1 服务端</h5><p>运行案例，程序输出如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"> 客户端流 RPC 模式</span><br><span class="line"><span class="number">201907300001</span> 衣服 已付款</span><br><span class="line"><span class="number">201907310001</span> 零食 已付款</span><br><span class="line"><span class="number">201907310002</span> 食品 未付款</span><br><span class="line"> 读取数据结束</span><br><span class="line"> 客户端流 RPC 模式</span><br><span class="line"><span class="number">201907300001</span> 衣服 已付款</span><br><span class="line"><span class="number">201907310001</span> 零食 已付款</span><br><span class="line"><span class="number">201907310002</span> 食品 未付款</span><br><span class="line"> 读取数据结束</span><br></pre></td></tr></table></figure></div>

<h5 id="1-2-6-2-客户端"><a href="#1-2-6-2-客户端" class="headerlink" title="1.2.6.2 客户端"></a>1.2.6.2 客户端</h5><p>客户端运行程序输出如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">客户端请求RPC调用：客户端流模式</span><br><span class="line"> 读取数据结束</span><br><span class="line"> 读取数据结束了</span><br></pre></td></tr></table></figure></div>

<h3 id="1-3、双向流模式"><a href="#1-3、双向流模式" class="headerlink" title="1.3、双向流模式"></a>1.3、双向流模式</h3><p>上文已经讲过了服务端流模式和客户端流模式。如果将客户端和服务端两种流模式结合起来,就是第三种模式，双向流模式。即客户端发送数据的时候以流数据发送，服务端返回数据也以流的形式进行发送，因此称之为双向流模式。</p>
<h4 id="1-3-1-双向流服务的定义"><a href="#1-3-1-双向流服务的定义" class="headerlink" title="1.3.1 双向流服务的定义"></a>1.3.1 双向流服务的定义</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//订单服务service定义</span></span><br><span class="line">service OrderService &#123;</span><br><span class="line">    rpc GetOrderInfos (stream OrderRequest) returns (stream OrderInfo) &#123;&#125;; <span class="comment">//双向流模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-3-2-编译-proto-文件"><a href="#1-3-2-编译-proto-文件" class="headerlink" title="1.3.2 编译.proto 文件"></a>1.3.2 编译.proto 文件</h4><h5 id="1-3-2-1-服务端接口实现"><a href="#1-3-2-1-服务端接口实现" class="headerlink" title="1.3.2.1 服务端接口实现"></a>1.3.2.1 服务端接口实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_GetOrderInfosServer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Send(*OrderInfo) error</span><br><span class="line">	Recv() (*OrderRequest, error)</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceGetOrderInfosServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ServerStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosServer)</span> <span class="title">Send</span><span class="params">(m *OrderInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x.ServerStream.SendMsg(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosServer)</span> <span class="title">Recv</span><span class="params">()</span> <span class="params">(*OrderRequest, error)</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">new</span>(OrderRequest)</span><br><span class="line">	<span class="keyword">if</span> err := x.ServerStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="1-3-2-2-客户端接口实现"><a href="#1-3-2-2-客户端接口实现" class="headerlink" title="1.3.2.2 客户端接口实现"></a>1.3.2.2 客户端接口实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> OrderService_GetOrderInfosClient <span class="keyword">interface</span> &#123;</span><br><span class="line">	Send(*OrderRequest) error</span><br><span class="line">	Recv() (*OrderInfo, error)</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> orderServiceGetOrderInfosClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	grpc.ClientStream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosClient)</span> <span class="title">Send</span><span class="params">(m *OrderRequest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> x.ClientStream.SendMsg(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(x *orderServiceGetOrderInfosClient)</span> <span class="title">Recv</span><span class="params">()</span> <span class="params">(*OrderInfo, error)</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">new</span>(OrderInfo)</span><br><span class="line">	<span class="keyword">if</span> err := x.ClientStream.RecvMsg(m); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-3-3-服务实现"><a href="#1-3-3-服务实现" class="headerlink" title="1.3.3 服务实现"></a>1.3.3 服务实现</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//实现grpc双向流模式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(os *OrderServiceImpl)</span> <span class="title">GetOrderInfos</span><span class="params">(stream message.OrderService_GetOrderInfosServer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		orderRequest, err := stream.Recv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(<span class="string">" 数据读取结束 "</span>)</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err.Error())</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		fmt.Println(orderRequest.GetOrderId())</span><br><span class="line">		orderMap := <span class="keyword">map</span>[<span class="keyword">string</span>]message.OrderInfo&#123;</span><br><span class="line">			<span class="string">"201907300001"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907300001"</span>, OrderName: <span class="string">"衣服"</span>, OrderStatus: <span class="string">"已付款"</span>&#125;,</span><br><span class="line">			<span class="string">"201907310001"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907310001"</span>, OrderName: <span class="string">"零食"</span>, OrderStatus: <span class="string">"已付款"</span>&#125;,</span><br><span class="line">			<span class="string">"201907310002"</span>: message.OrderInfo&#123;OrderId: <span class="string">"201907310002"</span>, OrderName: <span class="string">"食品"</span>, OrderStatus: <span class="string">"未付款"</span>&#125;,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		result := orderMap[orderRequest.GetOrderId()]</span><br><span class="line">		<span class="comment">//发送数据</span></span><br><span class="line">		err = stream.Send(&amp;result)</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err.Error())</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1-3-4-服务端及客户端的编程实现"><a href="#1-3-4-服务端及客户端的编程实现" class="headerlink" title="1.3.4 服务端及客户端的编程实现"></a>1.3.4 服务端及客户端的编程实现</h4><h5 id="1-3-4-1-服务端实现"><a href="#1-3-4-1-服务端实现" class="headerlink" title="1.3.4.1 服务端实现"></a>1.3.4.1 服务端实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := grpc.NewServer()</span><br><span class="line">	<span class="comment">//注册</span></span><br><span class="line">	message.RegisterOrderServiceServer(server, <span class="built_in">new</span>(OrderServiceImpl))</span><br><span class="line"></span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8092"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	server.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="1-3-4-2-客户端实现"><a href="#1-3-4-2-客户端实现" class="headerlink" title="1.3.4.2 客户端实现"></a>1.3.4.2 客户端实现</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1、Dail连接</span></span><br><span class="line">	conn, err := grpc.Dial(<span class="string">"localhost:8092"</span>, grpc.WithInsecure())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	orderServiceClient := message.NewOrderServiceClient(conn)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"客户端请求RPC调用：双向流模式"</span>)</span><br><span class="line">	orderIDs := []<span class="keyword">string</span>&#123;<span class="string">"201907300001"</span>, <span class="string">"201907310001"</span>, <span class="string">"201907310002"</span>&#125;</span><br><span class="line"></span><br><span class="line">	orderInfoClient, err := orderServiceClient.GetOrderInfos(context.Background())</span><br><span class="line">	<span class="keyword">for</span> _, orderID := <span class="keyword">range</span> orderIDs &#123;</span><br><span class="line">		orderRequest := message.OrderRequest&#123;OrderId: orderID&#125;</span><br><span class="line">		err := orderInfoClient.Send(&amp;orderRequest)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭</span></span><br><span class="line">	orderInfoClient.CloseSend()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		orderInfo, err := orderInfoClient.Recv()</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			fmt.Println(<span class="string">"读取结束"</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">"读取到的信息："</span>, orderInfo)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="二、TLS-验证和-Token-认证"><a href="#二、TLS-验证和-Token-认证" class="headerlink" title="二、TLS 验证和 Token 认证"></a>二、TLS 验证和 Token 认证</h2><p>上节课我们学习掌握了 grpc-go 框架的四种流模式。在实际的生产环境中，一个功能完整的服务，不仅包含基本的方法调用和数据交互的功能，还包括授权认证，数据追踪，负载均衡等方面。本节课，我们来看一下除了在 gRPC 调用过程中，如何实现授权认证，以及如何进行拦截处理。</p>
<h3 id="2-1-授权认证"><a href="#2-1-授权认证" class="headerlink" title="2.1 授权认证"></a>2.1 授权认证</h3><p>gRPC 中默认支持两种授权方式,分别是：SSL/TLS 认证方式、基于 Token 的认证方式。</p>
<h4 id="2-1-1-SSL-TLS-认证方式"><a href="#2-1-1-SSL-TLS-认证方式" class="headerlink" title="2.1.1 SSL/TLS 认证方式"></a>2.1.1 SSL/TLS 认证方式</h4><p>SSL 全称是 Secure Sockets Layer，又被称之为安全套接字层，是一种标准安全协议，用于在通信过程中建立客户端与服务器之间的加密链接。<br>TLS 的全称是 Transport Layer Security，TLS 是 SSL 的升级版。在使用的过程中，往往习惯于将 SSL 和 TLS 组合在一起写作 SSL/TLS。<br>简而言之，SSL/TLS 是一种用于网络通信中加密的安全协议。</p>
<h5 id="2-1-1-1-SSL-TLS-工作原理"><a href="#2-1-1-1-SSL-TLS-工作原理" class="headerlink" title="2.1.1.1 SSL/TLS 工作原理"></a>2.1.1.1 SSL/TLS 工作原理</h5><p>使用 SSL/TLS 协议对通信连接进行安全加密，是通过非对称加密的方式来实现的。所谓非对称加密方式又称之为公钥加密，密钥对由公钥和私钥两种密钥组成。私钥和公钥成对存在，先生成私钥，通过私钥生成对应的公钥。公钥可以公开，私钥进行妥善保存。</p>
<p>在加密过程中：客户端想要向服务器发起链接，首先会先向服务端请求要加密的公钥。获取到公钥后客户端使用公钥将信息进行加密，服务端接收到加密信息，使用私钥对信息进行解密并进行其他后续处理，完成整个信道加密并实现数据传输的过程。</p>
<h5 id="2-1-1-2-制作证书"><a href="#2-1-1-2-制作证书" class="headerlink" title="2.1.1.2 制作证书"></a>2.1.1.2 制作证书</h5><p>可以自己在本机计算机上安装 openssl，并生成相应的证书。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl ecparam -genkey -name secp384r1 -out server.key</span><br><span class="line">openssl req -new -x509 -sha256 -key server.key -out server.pem -days 3650</span><br></pre></td></tr></table></figure></div>

<h5 id="2-1-1-3-编程实现服务端"><a href="#2-1-1-3-编程实现服务端" class="headerlink" title="2.1.1.3 编程实现服务端"></a>2.1.1.3 编程实现服务端</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> MathManager <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mm *MathManager)</span> <span class="title">AddMethod</span><span class="params">(ctx context.Context, request *message.RequestArgs)</span> <span class="params">(response *message.Response, err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">" 服务端 Add方法 "</span>)</span><br><span class="line">	result := request.Args1 + request.Args2</span><br><span class="line">	fmt.Println(<span class="string">" 计算结果是："</span>, result)</span><br><span class="line">	response = <span class="built_in">new</span>(message.Response)</span><br><span class="line">	response.Code = <span class="number">1</span>;</span><br><span class="line">	response.Message = <span class="string">"执行成功"</span></span><br><span class="line">	<span class="keyword">return</span> response, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TLS认证</span></span><br><span class="line">	creds, err := credentials.NewServerTLSFromFile(<span class="string">"./keys/server.pem"</span>, <span class="string">"./keys/server.key"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		grpclog.Fatal(<span class="string">"加载在证书文件失败"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//实例化grpc server, 开启TLS认证</span></span><br><span class="line">	server := grpc.NewServer(grpc.Creds(creds))</span><br><span class="line"></span><br><span class="line">	message.RegisterMathServiceServer(server, <span class="built_in">new</span>(MathManager))</span><br><span class="line"></span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8092"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	server.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="2-1-1-3-编程实现客户端"><a href="#2-1-1-3-编程实现客户端" class="headerlink" title="2.1.1.3 编程实现客户端"></a>2.1.1.3 编程实现客户端</h5><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;TLS连接</span><br><span class="line">	creds, err :&#x3D; credentials.NewClientTLSFromFile(&quot;.&#x2F;keys&#x2F;server.pem&quot;, &quot;go-grpc-example&quot;)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		panic(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;1、Dail连接</span><br><span class="line">	conn, err :&#x3D; grpc.Dial(&quot;localhost:8092&quot;, grpc.WithTransportCredentials(creds))</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		panic(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	defer conn.Close()</span><br><span class="line"></span><br><span class="line">	serviceClient :&#x3D; message.NewMathServiceClient(conn)</span><br><span class="line"></span><br><span class="line">	addArgs :&#x3D; message.RequestArgs&#123;Args1: 3, Args2: 5&#125;</span><br><span class="line"></span><br><span class="line">	response, err :&#x3D; serviceClient.AddMethod(context.Background(), &amp;addArgs)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		grpclog.Fatal(err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(response.GetCode(), response.GetMessage())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="2-1-2-基于-Token-认证方式"><a href="#2-1-2-基于-Token-认证方式" class="headerlink" title="2.1.2 基于 Token 认证方式"></a>2.1.2 基于 Token 认证方式</h4><h5 id="2-1-2-1-Token-认证介绍"><a href="#2-1-2-1-Token-认证介绍" class="headerlink" title="2.1.2.1 Token 认证介绍"></a>2.1.2.1 Token 认证介绍</h5><p>在 web 应用的开发过程中，我们往往还会使用另外一种认证方式进行身份验证，那就是：Token 认证。基于 Token 的身份验证是无状态，不需要将用户信息服务存在服务器或者 session 中。</p>
<h5 id="2-1-2-2-Token-认证过程"><a href="#2-1-2-2-Token-认证过程" class="headerlink" title="2.1.2.2 Token 认证过程"></a>2.1.2.2 Token 认证过程</h5><p>基于 Token 认证的身份验证主要过程是：客户端在发送请求前，首先向服务器发起请求，服务器返回一个生成的 token 给客户端。客户端将 token 保存下来，用于后续每次请求时，携带着 token 参数。服务端在进行处理请求之前，会首先对 token 进行验证，只有 token 验证成功了，才会处理并返回相关的数据。</p>
<h5 id="2-1-2-3-gRPC-的自定义-Token-认证"><a href="#2-1-2-3-gRPC-的自定义-Token-认证" class="headerlink" title="2.1.2.3 gRPC 的自定义 Token 认证"></a>2.1.2.3 gRPC 的自定义 Token 认证</h5><p>在 gRPC 中，允许开发者自定义自己的认证规则，通过</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">grpc.WithPerRPCCredentials()</span><br></pre></td></tr></table></figure></div>

<p>设置自定义的认证规则。WithPerRPCCredentials 方法接收一个 PerRPCCredentials 类型的参数，进一步查看可以知道 PerRPCCredentials 是一个接口，定义如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> PerRPCCredentials <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetRequestMetadata(ctx context.Context, uri ...<span class="keyword">string</span>) (<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>, error)</span><br><span class="line">    RequireTransportSecurity() <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此，开发者可以实现以上接口，来定义自己的 token 信息。</p>
<p>在本案例中，我们自定义的 token 认证结构体如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//token认证</span></span><br><span class="line"><span class="keyword">type</span> TokenAuthentication <span class="keyword">struct</span> &#123;</span><br><span class="line">	AppKey    <span class="keyword">string</span></span><br><span class="line">	AppSecret <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//组织token信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ta *TokenAuthentication)</span> <span class="title">RequestMetaData</span><span class="params">(ctx context.Context, uri ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"appid"</span>:    ta.AppKey,</span><br><span class="line">		<span class="string">"appkey"</span>: ta.AppSecret,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否基于TLS认证进行安全传输</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *TokenAuthentication)</span> <span class="title">RequireTransportSecurity</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>需要注意的是，RequestMetaData 方法中的 appid 和 appkey 字段均需要保持小写，不能大写。RequireTransportSecurity 方法用于设置是否基于 tls 认证进行安全传输。</p>
<p>在客户端进行连接时，我们将自定义的 token 认证信息作为参数进行传入。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">auth := TokenAuthentication&#123;</span><br><span class="line">		AppKey:    <span class="string">"hello"</span>,</span><br><span class="line">		AppSecret: <span class="string">"20190812"</span>,</span><br><span class="line">&#125;</span><br><span class="line">conn, err := grpc.Dial(<span class="string">"localhost:8093"</span>, grpc.WithTransportCredentials(creds), grpc.WithPerRPCCredentials(&amp;auth))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="built_in">panic</span>(err.Error())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="2-1-2-4-服务端"><a href="#2-1-2-4-服务端" class="headerlink" title="2.1.2.4 服务端"></a>2.1.2.4 服务端</h5><p>在服务端的调用方法中实现对 token 请求参数的判断，可以通过 metadata 获取 token 认证信息。具体实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mm *MathManager)</span> <span class="title">AddMethod</span><span class="params">(ctx context.Context, request *message.RequestArgs)</span> <span class="params">(response *message.Response, err error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过metadata</span></span><br><span class="line">	md, exist := metadata.FromIncomingContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> !exist &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unauthenticated, <span class="string">"无Token认证信息"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> appKey <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> appSecret <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> key, ok := md[<span class="string">"appid"</span>]; ok &#123;</span><br><span class="line">		appKey = key[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> secret, ok := md[<span class="string">"appkey"</span>]; ok &#123;</span><br><span class="line">		appSecret = secret[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> appKey != <span class="string">"hello"</span> || appSecret != <span class="string">"20190812"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unauthenticated, <span class="string">"Token 不合法"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">" 服务端 Add方法 "</span>)</span><br><span class="line">	result := request.Args1 + request.Args2</span><br><span class="line">	fmt.Println(<span class="string">" 计算结果是："</span>, result)</span><br><span class="line">	response = <span class="built_in">new</span>(message.Response)</span><br><span class="line">	response.Code = <span class="number">1</span>;</span><br><span class="line">	response.Message = <span class="string">"执行成功"</span></span><br><span class="line">	<span class="keyword">return</span> response, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后，运行项目，token 认证成功。客户端修改 token 信息，再次运行，会发现提示 token 不合法。</p>
<h2 id="三、拦截器的使用"><a href="#三、拦截器的使用" class="headerlink" title="三、拦截器的使用"></a>三、拦截器的使用</h2><h3 id="3-1、需求"><a href="#3-1、需求" class="headerlink" title="3.1、需求"></a>3.1、需求</h3><p>在上节课程中，我们学习使用了 gRPC 框架中的两种认证方式：TLS 验证和 Token 验证。</p>
<p>但是，在服务端的方法中，每个方法都要进行 token 的判断。程序效率太低，可以优化一下处理逻辑，在调用服务端的具体方法之前，先进行拦截，并进行 token 验证判断，这种方式称之为拦截器处理。</p>
<p>除了此处的 token 验证判断处理以外，还可以进行日志处理等。</p>
<h3 id="3-2、Interceptor"><a href="#3-2、Interceptor" class="headerlink" title="3.2、Interceptor"></a>3.2、Interceptor</h3><p>使用拦截器，首先需要注册。<br>在 grpc 中编程实现中，可以在 NewSever 时添加拦截器设置，grpc 框架中可以通过 UnaryInterceptor 方法设置自定义的拦截器，并返回 ServerOption。具体代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">grpc.UnaryInterceptor()</span><br></pre></td></tr></table></figure></div>

<p>UnaryInterceptor()接收一个 UnaryServerInterceptor 类型，继续查看源码定义，可以发现 UnaryServerInterceptor 是一个 func，定义如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> UnaryServerInterceptor <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *UnaryServerInfo, handler UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span></span><br></pre></td></tr></table></figure></div>

<p>通过以上代码，如果开发者需要注册自定义拦截器，需要自定义实现 UnaryServerInterceptor 的定义。</p>
<h3 id="3-3、自定义-UnaryServerInterceptor"><a href="#3-3、自定义-UnaryServerInterceptor" class="headerlink" title="3.3、自定义 UnaryServerInterceptor"></a>3.3、自定义 UnaryServerInterceptor</h3><p>接下来就自定义实现 func,符合 UnaryServerInterceptor 的标准，在该 func 的定义中实现对 token 的验证逻辑。自定义实现 func 如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TokenInterceptor</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span> <span class="params">(resp <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过metadata</span></span><br><span class="line">	md, exist := metadata.FromIncomingContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> !exist &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unauthenticated, <span class="string">"无Token认证信息"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> appKey <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> appSecret <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> key, ok := md[<span class="string">"appid"</span>]; ok &#123;</span><br><span class="line">		appKey = key[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> secret, ok := md[<span class="string">"appkey"</span>]; ok &#123;</span><br><span class="line">		appSecret = secret[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> appKey != <span class="string">"hello"</span> || appSecret != <span class="string">"20190812"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.Unauthenticated, <span class="string">"Token 不合法"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过token验证，继续处理请求</span></span><br><span class="line">	<span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在自定义的 TokenInterceptor 方法定义中,和之前在服务的方法调用的验证逻辑一致，从 metadata 中取出请求头中携带的 token 认证信息，并进行验证是否正确。如果 token 验证通过，则继续处理请求后续逻辑，后续继续处理可以由 grpc.UnaryHandler 进行处理。grpc.UnaryHandler 同样是一个方法，其具体的实现就是开发者自定义实现的服务方法。grpc.UnaryHandler 接口定义源码定义如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> UnaryHandler <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span></span><br></pre></td></tr></table></figure></div>

<h3 id="3-4、拦截器注册"><a href="#3-4、拦截器注册" class="headerlink" title="3.4、拦截器注册"></a>3.4、拦截器注册</h3><p>在服务端调用 grpc.NewServer 时进行拦截器的注册。详细如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">server := grpc.NewServer(grpc.Creds(creds), grpc.UnaryInterceptor(TokenInterceptor))</span><br></pre></td></tr></table></figure></div>

<h3 id="3-5、项目运行"><a href="#3-5、项目运行" class="headerlink" title="3.5、项目运行"></a>3.5、项目运行</h3><p>依次运行 server.go 程序和 client.go 程序，可以得到程序运行的正确结果。修改 token 携带值，可以验证 token 非法情况的拦截器效果。</p>
<h1 id="四-日志"><a href="#四-日志" class="headerlink" title="四. 日志"></a>四. 日志</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> initialize</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"go.uber.org/zap"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLogger</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logger, _ := zap.NewDevelopment()</span><br><span class="line">	zap.ReplaceGlobals(logger)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">zap.S().Infof(<span class="string">"配置信息: &amp;v"</span>, global.NacosConfig)</span><br></pre></td></tr></table></figure></div>

<h1 id="五-gRPC-错误处理"><a href="#五-gRPC-错误处理" class="headerlink" title="五. gRPC 错误处理"></a>五. gRPC 错误处理</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleGrpcErrorToHttp</span><span class="params">(err error, c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">//将grpc的code转换成http的状态码</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> e, ok := status.FromError(err); ok &#123;</span><br><span class="line">			<span class="keyword">switch</span> e.Code() &#123;</span><br><span class="line">			<span class="keyword">case</span> codes.NotFound:</span><br><span class="line">				c.JSON(http.StatusNotFound, gin.H&#123;</span><br><span class="line">					<span class="string">"msg"</span>: e.Message(),</span><br><span class="line">				&#125;)</span><br><span class="line">			<span class="keyword">case</span> codes.Internal:</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;</span><br><span class="line">					<span class="string">"msg:"</span>: <span class="string">"内部错误"</span>,</span><br><span class="line">				&#125;)</span><br><span class="line">			<span class="keyword">case</span> codes.InvalidArgument:</span><br><span class="line">				c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">					<span class="string">"msg"</span>: <span class="string">"参数错误"</span>,</span><br><span class="line">				&#125;)</span><br><span class="line">			<span class="keyword">case</span> codes.Unavailable:</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;</span><br><span class="line">					<span class="string">"msg"</span>: <span class="string">"用户服务不可用"</span>,</span><br><span class="line">				&#125;)</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				c.JSON(http.StatusInternalServerError, gin.H&#123;</span><br><span class="line">					<span class="string">"msg"</span>: e.Code(),</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">rsp, err := global.UserSrvClient.GetUserList(context.Background(), &amp;proto.PageInfo&#123;</span><br><span class="line">		Pn:    <span class="keyword">uint32</span>(pnInt),</span><br><span class="line">		PSize: <span class="keyword">uint32</span>(pSizeInt),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		zap.S().Errorw(<span class="string">"[GetUserList] 查询 【用户列表】失败"</span>)</span><br><span class="line">		HandleGrpcErrorToHttp(err, ctx)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="六-日期转换"><a href="#六-日期转换" class="headerlink" title="六.日期转换"></a>六.日期转换</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> reponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> JsonTime time.Time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j JsonTime)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> stmp = fmt.Sprintf(<span class="string">"\"%s\""</span>, time.Time(j).Format(<span class="string">"2006-01-02"</span>))</span><br><span class="line">	<span class="keyword">return</span> []<span class="keyword">byte</span>(stmp), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id <span class="keyword">int32</span> <span class="string">`json:"id"`</span></span><br><span class="line">	NickName <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	<span class="comment">//Birthday string `json:"birthday"`</span></span><br><span class="line">	Birthday JsonTime <span class="string">`json:"birthday"`</span></span><br><span class="line">	Gender <span class="keyword">string</span> <span class="string">`json:"gender"`</span></span><br><span class="line">	Mobile <span class="keyword">string</span> <span class="string">`json:"mobile"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, value := <span class="keyword">range</span> rsp.Data &#123;</span><br><span class="line">		user := reponse.UserResponse&#123;</span><br><span class="line">			Id:       value.Id,</span><br><span class="line">			NickName: value.NickName,</span><br><span class="line">			<span class="comment">//Birthday: time.Time(time.Unix(int64(value.BirthDay), 0)).Format("2006-01-02"),</span></span><br><span class="line">			Birthday: reponse.JsonTime(time.Unix(<span class="keyword">int64</span>(value.BirthDay), <span class="number">0</span>)),</span><br><span class="line">			Gender:   value.Gender,</span><br><span class="line">			Mobile:   value.Mobile,</span><br><span class="line">		&#125;</span><br><span class="line">		result = <span class="built_in">append</span>(result, user)</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.JSON(http.StatusOK, result)</span><br></pre></td></tr></table></figure></div>

<h1 id="七-配置"><a href="#七-配置" class="headerlink" title="七.配置"></a>七.配置</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetEnvInfo</span><span class="params">(env <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	viper.AutomaticEnv()</span><br><span class="line">	<span class="keyword">return</span> viper.GetBool(env)</span><br><span class="line">	<span class="comment">//刚才设置的环境变量 想要生效 我们必须得重启goland</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">	debug := GetEnvInfo(<span class="string">"MXSHOP_DEBUG"</span>)</span><br><span class="line">	configFilePrefix := <span class="string">"config"</span></span><br><span class="line">	configFileName := fmt.Sprintf(<span class="string">"user-web/%s-pro.yaml"</span>, configFilePrefix)</span><br><span class="line">	<span class="keyword">if</span> debug &#123;</span><br><span class="line">		configFileName = fmt.Sprintf(<span class="string">"user-web/%s-debug.yaml"</span>, configFilePrefix)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	v := viper.New()</span><br><span class="line">	<span class="comment">//文件的路径如何设置</span></span><br><span class="line">	v.SetConfigFile(configFileName)</span><br><span class="line">	<span class="keyword">if</span> err := v.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//这个对象如何在其他文件中使用 - 全局变量</span></span><br><span class="line">	<span class="keyword">if</span> err := v.Unmarshal(global.NacosConfig); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="八-web-验证错误信息"><a href="#八-web-验证错误信息" class="headerlink" title="八.web 验证错误信息"></a>八.web 验证错误信息</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleValidatorError</span><span class="params">(c *gin.Context, err error)</span></span>&#123;</span><br><span class="line">	errs, ok := err.(validator.ValidationErrors)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">			<span class="string">"msg"</span>:err.Error(),</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">		<span class="string">"error"</span>: removeTopStruct(errs.Translate(global.Trans)),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PassWordLogin</span><span class="params">(c *gin.Context)</span></span>&#123;</span><br><span class="line">	<span class="comment">//表单验证</span></span><br><span class="line">	passwordLoginForm := forms.PassWordLoginForm&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.ShouldBind(&amp;passwordLoginForm); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		HandleValidatorError(c, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="九-JWT"><a href="#九-JWT" class="headerlink" title="九. JWT"></a>九. JWT</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/dgrijalva/jwt-go"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CustomClaims <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID          <span class="keyword">uint</span></span><br><span class="line">	NickName    <span class="keyword">string</span></span><br><span class="line">	AuthorityId <span class="keyword">uint</span></span><br><span class="line">	jwt.StandardClaims</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> middlewares</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">	<span class="string">"github.com/dgrijalva/jwt-go"</span></span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">	<span class="string">"mxshop-api/user-web/global"</span></span><br><span class="line">	<span class="string">"mxshop-api/user-web/models"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">JWTAuth</span><span class="params">()</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 我们这里jwt鉴权取头部信息 x-token 登录时回返回token信息 这里前端需要把token存储到cookie或者本地localSstorage中 不过需要跟后端协商过期时间 可以约定刷新令牌或者重新登录</span></span><br><span class="line">		token := c.Request.Header.Get(<span class="string">"x-token"</span>)</span><br><span class="line">		<span class="keyword">if</span> token == <span class="string">""</span> &#123;</span><br><span class="line">			c.JSON(http.StatusUnauthorized, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">				<span class="string">"msg"</span>:<span class="string">"请登录"</span>,</span><br><span class="line">			&#125;)</span><br><span class="line">			c.Abort()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		j := NewJWT()</span><br><span class="line">		<span class="comment">// parseToken 解析token包含的信息</span></span><br><span class="line">		claims, err := j.ParseToken(token)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == TokenExpired &#123;</span><br><span class="line">				<span class="keyword">if</span> err == TokenExpired &#123;</span><br><span class="line">					c.JSON(http.StatusUnauthorized, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">						<span class="string">"msg"</span>:<span class="string">"授权已过期"</span>,</span><br><span class="line">					&#125;)</span><br><span class="line">					c.Abort()</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			c.JSON(http.StatusUnauthorized, <span class="string">"未登陆"</span>)</span><br><span class="line">			c.Abort()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		c.Set(<span class="string">"claims"</span>, claims)</span><br><span class="line">		c.Set(<span class="string">"userId"</span>, claims.ID)</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> JWT <span class="keyword">struct</span> &#123;</span><br><span class="line">	SigningKey []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	TokenExpired     = errors.New(<span class="string">"Token is expired"</span>)</span><br><span class="line">	TokenNotValidYet = errors.New(<span class="string">"Token not active yet"</span>)</span><br><span class="line">	TokenMalformed   = errors.New(<span class="string">"That's not even a token"</span>)</span><br><span class="line">	TokenInvalid     = errors.New(<span class="string">"Couldn't handle this token:"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewJWT</span><span class="params">()</span> *<span class="title">JWT</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;JWT&#123;</span><br><span class="line">		[]<span class="keyword">byte</span>(global.ServerConfig.JWTInfo.SigningKey), <span class="comment">//可以设置过期时间</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个token</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JWT)</span> <span class="title">CreateToken</span><span class="params">(claims models.CustomClaims)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">	<span class="keyword">return</span> token.SignedString(j.SigningKey)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 token</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JWT)</span> <span class="title">ParseToken</span><span class="params">(tokenString <span class="keyword">string</span>)</span> <span class="params">(*models.CustomClaims, error)</span></span> &#123;</span><br><span class="line">	token, err := jwt.ParseWithClaims(tokenString, &amp;models.CustomClaims&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(i <span class="keyword">interface</span>&#123;&#125;, e error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> j.SigningKey, <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ve, ok := err.(*jwt.ValidationError); ok &#123;</span><br><span class="line">			<span class="keyword">if</span> ve.Errors&amp;jwt.ValidationErrorMalformed != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, TokenMalformed</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ve.Errors&amp;jwt.ValidationErrorExpired != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="comment">// Token is expired</span></span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, TokenExpired</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ve.Errors&amp;jwt.ValidationErrorNotValidYet != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, TokenNotValidYet</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, TokenInvalid</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> token != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> claims, ok := token.Claims.(*models.CustomClaims); ok &amp;&amp; token.Valid &#123;</span><br><span class="line">			<span class="keyword">return</span> claims, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, TokenInvalid</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, TokenInvalid</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新token</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j *JWT)</span> <span class="title">RefreshToken</span><span class="params">(tokenString <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	jwt.TimeFunc = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> time.Unix(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	token, err := jwt.ParseWithClaims(tokenString, &amp;models.CustomClaims&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> j.SigningKey, <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> claims, ok := token.Claims.(*models.CustomClaims); ok &amp;&amp; token.Valid &#123;</span><br><span class="line">		jwt.TimeFunc = time.Now</span><br><span class="line">		claims.StandardClaims.ExpiresAt = time.Now().Add(<span class="number">1</span> * time.Hour).Unix()</span><br><span class="line">		<span class="keyword">return</span> j.CreateToken(*claims)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">""</span>, TokenInvalid</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> JWTConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	SigningKey <span class="keyword">string</span> <span class="string">`mapstructure:"key" json:"key"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">//生成token</span></span><br><span class="line">				j := middlewares.NewJWT()</span><br><span class="line">				claims := models.CustomClaims&#123;</span><br><span class="line">					ID:             <span class="keyword">uint</span>(rsp.Id),</span><br><span class="line">					NickName:       rsp.NickName,</span><br><span class="line">					AuthorityId:    <span class="keyword">uint</span>(rsp.Role),</span><br><span class="line">					StandardClaims: jwt.StandardClaims&#123;</span><br><span class="line">						NotBefore: time.Now().Unix(), <span class="comment">//签名的生效时间</span></span><br><span class="line">						ExpiresAt: time.Now().Unix() + <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">30</span>, <span class="comment">//30天过期</span></span><br><span class="line">						Issuer: <span class="string">"imooc"</span>,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;</span><br><span class="line">				token, err := j.CreateToken(claims)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					c.JSON(http.StatusInternalServerError, gin.H&#123;</span><br><span class="line">						<span class="string">"msg"</span>:<span class="string">"生成token失败"</span>,</span><br><span class="line">					&#125;)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">					<span class="string">"id"</span>: rsp.Id,</span><br><span class="line">					<span class="string">"nick_name"</span>: rsp.NickName,</span><br><span class="line">					<span class="string">"token"</span>: token,</span><br><span class="line">					<span class="string">"expired_at"</span>: (time.Now().Unix() + <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">30</span>)*<span class="number">1000</span>,</span><br><span class="line">				&#125;)</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitUserRouter</span><span class="params">(Router *gin.RouterGroup)</span></span>&#123;</span><br><span class="line">	UserRouter := Router.Group(<span class="string">"user"</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		UserRouter.GET(<span class="string">"list"</span>, middlewares.JWTAuth(), middlewares.IsAdminAuth(), api.GetUserList)</span><br><span class="line">		UserRouter.POST(<span class="string">"pwd_login"</span>, api.PassWordLogin)</span><br><span class="line">		UserRouter.POST(<span class="string">"register"</span>, api.Register)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//服务注册和发现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十-跨域"><a href="#十-跨域" class="headerlink" title="十. 跨域"></a>十. 跨域</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> middlewares</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cors</span><span class="params">()</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		method := c.Request.Method</span><br><span class="line"></span><br><span class="line">		c.Header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">		c.Header(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,AccessToken,X-CSRF-Token, Authorization, Token, x-token"</span>)</span><br><span class="line">		c.Header(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST, GET, OPTIONS, DELETE, PATCH, PUT"</span>)</span><br><span class="line">		c.Header(<span class="string">"Access-Control-Expose-Headers"</span>, <span class="string">"Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers, Content-Type"</span>)</span><br><span class="line">		c.Header(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> method == <span class="string">"OPTIONS"</span> &#123;</span><br><span class="line">			c.AbortWithStatus(http.StatusNoContent)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">Router.Use(middlewares.Cors())</span><br></pre></td></tr></table></figure></div>

<h1 id="十一-动态获取端口"><a href="#十一-动态获取端口" class="headerlink" title="十一. 动态获取端口"></a>十一. 动态获取端口</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetFreePort</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	addr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, <span class="string">"localhost:0"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l, err := net.ListenTCP(<span class="string">"tcp"</span>, addr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> l.Close()</span><br><span class="line">	<span class="keyword">return</span> l.Addr().(*net.TCPAddr).Port,  <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十二-服务注册与发现"><a href="#十二-服务注册与发现" class="headerlink" title="十二. 服务注册与发现"></a>十二. 服务注册与发现</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/hashicorp/consul/api"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Register</span><span class="params">(address <span class="keyword">string</span>, port <span class="keyword">int</span>, name <span class="keyword">string</span>, tags []<span class="keyword">string</span>, id <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">"192.168.1.103:8500"</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//生成对应的检查对象</span></span><br><span class="line">	check := &amp;api.AgentServiceCheck&#123;</span><br><span class="line">		HTTP:                           <span class="string">"http://192.168.1.102:8021/health"</span>,</span><br><span class="line">		Timeout:                        <span class="string">"5s"</span>,</span><br><span class="line">		Interval:                       <span class="string">"5s"</span>,</span><br><span class="line">		DeregisterCriticalServiceAfter: <span class="string">"10s"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成注册对象</span></span><br><span class="line">	registration := <span class="built_in">new</span>(api.AgentServiceRegistration)</span><br><span class="line">	registration.Name = name</span><br><span class="line">	registration.ID = id</span><br><span class="line">	registration.Port = port</span><br><span class="line">	registration.Tags = tags</span><br><span class="line">	registration.Address = address</span><br><span class="line">	registration.Check = check</span><br><span class="line"></span><br><span class="line">	err = client.Agent().ServiceRegister(registration)</span><br><span class="line">	client.Agent().ServiceDeregister()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AllServices</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">"192.168.1.103:8500"</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	data, err := client.Agent().Services()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> key, _ := <span class="keyword">range</span> data &#123;</span><br><span class="line">		fmt.Println(key)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FilterSerivice</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg := api.DefaultConfig()</span><br><span class="line">	cfg.Address = <span class="string">"192.168.1.103:8500"</span></span><br><span class="line"></span><br><span class="line">	client, err := api.NewClient(cfg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	data, err := client.Agent().ServicesWithFilter(<span class="string">`Service == "user-web"`</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> key, _ := <span class="keyword">range</span> data &#123;</span><br><span class="line">		fmt.Println(key)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//_ = Register("192.168.1.102", 8021, "user-web", []string&#123;"mxshop", "bobby"&#125;, "user-web")</span></span><br><span class="line">	<span class="comment">//AllServices()</span></span><br><span class="line">	<span class="comment">//FilterSerivice()</span></span><br><span class="line">	fmt.Println(fmt.Sprintf(<span class="string">`Service == "%s"`</span>, <span class="string">"user-srv"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十三-负载均衡"><a href="#十三-负载均衡" class="headerlink" title="十三. 负载均衡"></a>十三. 负载均衡</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"OldPackageTest/grpclb_test/proto"</span></span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">	_ <span class="string">"github.com/mbobakov/grpc-consul-resolver"</span> <span class="comment">// It's important</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	conn, err := grpc.Dial(</span><br><span class="line">		<span class="string">"consul://192.168.1.103:8500/user-srv?wait=14s&amp;tag=srv"</span>,</span><br><span class="line">		grpc.WithInsecure(),</span><br><span class="line">		grpc.WithDefaultServiceConfig(<span class="string">`&#123;"loadBalancingPolicy": "round_robin"&#125;`</span>),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		userSrvClient := proto.NewUserClient(conn)</span><br><span class="line">		rsp, err := userSrvClient.GetUserList(context.Background(), &amp;proto.PageInfo&#123;</span><br><span class="line">			Pn:    <span class="number">1</span>,</span><br><span class="line">			PSize: <span class="number">2</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> index, data := <span class="keyword">range</span> rsp.Data &#123;</span><br><span class="line">			fmt.Println(index, data)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十四-Nacos-配置中心"><a href="#十四-Nacos-配置中心" class="headerlink" title="十四. Nacos 配置中心"></a>十四. Nacos 配置中心</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"OldPackageTest/nacos_test/config"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/nacos-group/nacos-sdk-go/clients"</span></span><br><span class="line">	<span class="string">"github.com/nacos-group/nacos-sdk-go/common/constant"</span></span><br><span class="line">	<span class="string">"github.com/nacos-group/nacos-sdk-go/vo"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sc := []constant.ServerConfig&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			IpAddr: <span class="string">"192.168.1.103"</span>,</span><br><span class="line">			Port:   <span class="number">8848</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cc := constant.ClientConfig&#123;</span><br><span class="line">		NamespaceId:         <span class="string">"c1872978-d51c-4188-a497-4e0cd20b97d5"</span>, <span class="comment">// 如果需要支持多namespace，我们可以场景多个client,它们有不同的NamespaceId</span></span><br><span class="line">		TimeoutMs:           <span class="number">5000</span>,</span><br><span class="line">		NotLoadCacheAtStart: <span class="literal">true</span>,</span><br><span class="line">		LogDir:              <span class="string">"tmp/nacos/log"</span>,</span><br><span class="line">		CacheDir:            <span class="string">"tmp/nacos/cache"</span>,</span><br><span class="line">		RotateTime:          <span class="string">"1h"</span>,</span><br><span class="line">		MaxAge:              <span class="number">3</span>,</span><br><span class="line">		LogLevel:            <span class="string">"debug"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	configClient, err := clients.CreateConfigClient(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">"serverConfigs"</span>: sc,</span><br><span class="line">		<span class="string">"clientConfig"</span>:  cc,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	content, err := configClient.GetConfig(vo.ConfigParam&#123;</span><br><span class="line">		DataId: <span class="string">"user-web.json"</span>,</span><br><span class="line">		Group:  <span class="string">"dev"</span>&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//fmt.Println(content) //字符串 - yaml</span></span><br><span class="line">	serverConfig := config.ServerConfig&#123;&#125;</span><br><span class="line">	<span class="comment">//想要将一个json字符串转换成struct，需要去设置这个struct的tag</span></span><br><span class="line">	json.Unmarshal([]<span class="keyword">byte</span>(content), &amp;serverConfig)</span><br><span class="line">	fmt.Println(serverConfig)</span><br><span class="line">	<span class="comment">//err = configClient.ListenConfig(vo.ConfigParam&#123;</span></span><br><span class="line">	<span class="comment">//	DataId: "user-web.json",</span></span><br><span class="line">	<span class="comment">//	Group:  "dev",</span></span><br><span class="line">	<span class="comment">//	OnChange: func(namespace, group, dataId, data string) &#123;</span></span><br><span class="line">	<span class="comment">//		fmt.Println("配置文件变化")</span></span><br><span class="line">	<span class="comment">//		fmt.Println("group:" + group + ", dataId:" + dataId + ", data:" + data)</span></span><br><span class="line">	<span class="comment">//	&#125;,</span></span><br><span class="line">	<span class="comment">//&#125;)</span></span><br><span class="line">	<span class="comment">//time.Sleep(3000 * time.Second)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">go</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UserSrvConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host <span class="keyword">string</span> <span class="string">`mapstructure:"host" json:"host"`</span></span><br><span class="line">	Port <span class="keyword">int</span>    <span class="string">`mapstructure:"port" json:"port"`</span></span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`mapstructure:"name" json:"name"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> JWTConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	SigningKey <span class="keyword">string</span> <span class="string">`mapstructure:"key" json:"key"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AliSmsConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	ApiKey     <span class="keyword">string</span> <span class="string">`mapstructure:"key" json:"key"`</span></span><br><span class="line">	ApiSecrect <span class="keyword">string</span> <span class="string">`mapstructure:"secrect" json:"secrect"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ConsulConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host <span class="keyword">string</span> <span class="string">`mapstructure:"host" json:"host"`</span></span><br><span class="line">	Port <span class="keyword">int</span>    <span class="string">`mapstructure:"port" json:"port"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RedisConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Host   <span class="keyword">string</span> <span class="string">`mapstructure:"host" json:"host"`</span></span><br><span class="line">	Port   <span class="keyword">int</span>    <span class="string">`mapstructure:"port" json:"port"`</span></span><br><span class="line">	Expire <span class="keyword">int</span>    <span class="string">`mapstructure:"expire" json:"expire"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServerConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name        <span class="keyword">string</span>        <span class="string">`mapstructure:"name" json:"name"`</span></span><br><span class="line">	Port        <span class="keyword">int</span>           <span class="string">`mapstructure:"port" json:"port"`</span></span><br><span class="line">	UserSrvInfo UserSrvConfig <span class="string">`mapstructure:"user_srv" json:"user_srv"`</span></span><br><span class="line">	JWTInfo     JWTConfig     <span class="string">`mapstructure:"jwt" json:"jwt"`</span></span><br><span class="line">	AliSmsInfo  AliSmsConfig  <span class="string">`mapstructure:"sms" json:"sms"`</span></span><br><span class="line">	RedisInfo   RedisConfig   <span class="string">`mapstructure:"redis" json:"redis"`</span></span><br><span class="line">	ConsulInfo  ConsulConfig  <span class="string">`mapstructure:"consul" json:"consul"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">wangguangatap</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wangguangatap.github.io/2020/01/27/gRPC%E4%BD%BF%E7%94%A8/">https://wangguangatap.github.io/2020/01/27/gRPC%E4%BD%BF%E7%94%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://wangguangatap.github.io/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wangguangatap.github.io">星脉</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang    </a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务    </a><a class="post-meta__tags" href="/tags/gRPC/">gRPC    </a></div><div class="post_share"><div class="social-share" data-image="/img/weifuwu/weifuwu.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/01/27/gRPC%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D/"><img class="prev_cover lazyload" data-src="/img/weifuwu/weifuwu.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>微服务：(五)gRPC远程调用机制介绍</span></div></a></div><div class="next-post pull_right"><a href="/2020/01/27/go-micro%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/"><img class="next_cover lazyload" data-src="/img/weifuwu/weifuwu.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>微服务：(七)go-micro框架介绍</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/27/gRPC远程调用机制介绍/" title="微服务：(五)gRPC远程调用机制介绍"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(五)gRPC远程调用机制介绍</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/go-micro使用(一)/" title="微服务：(八)go-micro使用(一)"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(八)go-micro使用(一)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务简介及特性介绍/" title="微服务：(一)微服务简介及特性介绍"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(一)微服务简介及特性介绍</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/Protobuf介绍/" title="微服务：(二)Protobuf介绍"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(二)Protobuf介绍</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务管理(上)/" title="微服务：(二)微服务管理(上)"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(二)微服务管理(上)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/27/微服务管理(下)/" title="微服务：(三)微服务管理(下)"><img class="relatedPosts_cover lazyload"data-src="/img/weifuwu/weifuwu.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-27</div><div class="relatedPosts_title">微服务：(三)微服务管理(下)</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By wangguangatap</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon_piao" mobile="false" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/piao.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>